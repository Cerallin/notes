name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch: # 允许手动触发

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - id: meta
        run: |
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image=ghcr.io/${REPO}/devcontainer:latest" >> $GITHUB_OUTPUT

  deploy:
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      contents: write # 用于 hexo deploy 推送到 gh-pages
    container:
      image: ${{ needs.setup.outputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Add dependencies to PATH
        run: echo "/opt/dependencies" >> $GITHUB_PATH

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize submodules
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git submodule init
          git submodule update --remote

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: npm ci

      - name: Configure Git for deploy
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Build
        run: npm run build

      - name: Deploy to gh-pages
        run: npx hexo deploy --repo https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
