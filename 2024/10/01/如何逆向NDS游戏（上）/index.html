<html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="这篇文章介绍了逆向工程任天堂DS游戏的全过程，以《宝可梦不可思议的迷宫：空之探险队》为案例，涵盖了环境配置、工具使用及关键技术。内容包括通过Ghidra静态分析二进制文件、使用DeSmuME模拟器进行动态调试、解压ROM并识别关键数据文件等详细步骤。最后引导需要的技能基础和进一步学习路径，适合对游戏机制探索及修改感兴趣的读者。"><title>如何逆向NDS游戏（上）：配置环境 - Cerallin的笔记本 - 瞎折腾～～</title><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="/notes/css/style.css"><link rel="stylesheet" href="/notes/css/helpers.css"><script src="/notes/js/clipboard/clipboard.min.js"></script><script src="/notes/js/bootstrap.js"></script><script>Theme.counter={register:function(){request("//visitor-counter.cerallin.top/count.php/?page="+encodeURI(window.location.href),{method:"GET"}).then(e=>{for(var t in e){var n=document.getElementById(t);n&&(n.innerText=e[t])}}).catch(e=>{console.error("Fetching visit count failed.",e)})}}</script><style>body hl:after {
    content: ' ';
    display: inline;
    font-family: inherit;
    font-size: 0.45em;
}

html code hl,
html pre hl,
html kbd hl,
html samp hl,
html ruby hl,
html .tag-list-item hl {
    display: none;
}

html ol > hl,
html ul > hl {
    display: none;
}</style><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/notes/atom.xml" title="Cerallin的笔记本" type="application/atom+xml"></head><body><div class="loading-wrapper" data-loading="data-loading"><div class="loading"><span></span><span></span><span></span></div></div><div class="page" data-filter="data-filter"><div class="head" data-show="data-show"><header class="head-header"><div class="head-author"><a class="head-author-link" href="/notes/">Cerallin<hl></hl>的笔记本</a></div><div class="head-right"><button class="bar-wrap" id="bar-wrap-toggle" title="菜单按钮"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button><div class="head-item"><a class="search-button head-item-link"><span>搜索</span> <i class="icon icon-search"></i></a></div><div class="head-item"><a class="head-item-link" href="/notes/about">关于</a></div></div></header><div class="menubar-head" id="menubar"><ul class="menubar-ul"><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%8E%E9%80%9A%E4%BF%A1%E5%B7%A5%E7%A8%8B/">计算机与通信工程</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E6%9D%90%E6%96%99%E7%A7%91%E5%AD%A6%E4%B8%8E%E5%B7%A5%E7%A8%8B/">材料科学与工程</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/">瞎折腾</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E6%B5%85%E6%80%9D/">浅思</a></li><li class="menubar-item" data-border="data-border"></li><li class="menubar-item"><i class="icon icon-archive"></i> <a class="menubar-link" href="/notes/archives">归档</a></li><li class="menubar-item"><i class="icon icon-tags"></i> <a class="menubar-link" href="/notes/tags">标签</a></li><li class="menubar-item" data-border="data-border"></li><li class="menubar-item"><a class="menubar-link" href="/notes/about"><span>关于</span></a></li></ul><div class="menu-search-box search-button"><div>搜索</div><i class="icon icon-search"></i></div></div></div><div class="main" data-page="post"><article class="post" id="post"><header class="post-head"><h1 class="post-title"><a class="title" href="/notes/2024/10/01/%E5%A6%82%E4%BD%95%E9%80%86%E5%90%91NDS%E6%B8%B8%E6%88%8F%EF%BC%88%E4%B8%8A%EF%BC%89/">如何逆向<hl></hl>NDS<hl></hl>游戏（上）：配置环境<hl></hl></a></h1></header><div class="post-meta"><div class="post-date"><time class="post-time" itemprop="datePublished" title="2024-10-01 13:11:38" datetime="2024-10-01T05:11:38.000Z">2024-10-01</time></div>|<div class="post-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/ARM/" rel="tag">ARM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/NDS/" rel="tag">NDS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/%E6%B1%87%E7%BC%96/" rel="tag"><hl></hl>汇编</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" rel="tag">逆向工程</a></li></ul></div><div class="post-visit"><span id="page_pv">?</span><hl></hl>访问</div></div><div class="post-info"><div class="post-word-count">本文共<hl></hl>3,327<hl></hl>字。</div><div class="post-cc">版权声明：署名 | <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div><div class="article-entry" itemprop="articleBody"><blockquote><p>本文译自《<a target="_blank" rel="noopener" href="https://www.starcubelabs.com/reverse-engineering-ds/">Reverse Engineering a DS Game</a>》。</p></blockquote><p>本教程将使用任天堂<hl></hl>DS<hl></hl>游戏《宝可梦不可思议的迷宫：空之探险队》演示介绍逆向游戏的通用流程，本文所使用的技巧也可用于其他游戏。</p><span id="more"></span><h2 id="关于本教程">关于本教程</h2><p>本教程将手把手教你：</p><ul><li>配置逆向工程环境。</li><li>入门汇编语言。</li><li>使用逆向工具<hl></hl>Ghidra<hl></hl>分析汇编代码。</li><li>使用<hl></hl>DesmuME<hl></hl>模拟器的调试工具：检查游戏内存<hl></hl>/<hl></hl>运行时调试。</li><li>寻找游戏资源和数据的逆向工程策略。</li></ul><p>本教程讨论了一些特定于<hl></hl>NDS<hl></hl>游戏的逆向工程技巧。如果你需要更通用的逆向工程教程，我（译注：原作者）推荐你去看<hl></hl><a target="_blank" rel="noopener" href="https://www.starcubelabs.com/reverse-engineering-gba">GBA<hl></hl>版</a>教程。</p><h3 id="跟随本教程需要什么技能">跟随本教程需要什么技能？</h3><ul><li>编程知识（最好有<hl></hl>C<hl></hl>或<hl></hl>C++），加上下列相关方面：<ul><li>指针</li><li>结构体</li><li>位运算</li><li>16<hl></hl>进制数字</li></ul></li><li>能使用模拟器基本顺畅地运行游戏。</li><li>对游戏逆向感兴趣！</li></ul><h2 id="什么是逆向工程">什么是逆向工程</h2><p>在编程语境里，逆向工程是指在不访问程序的原始实现（即源代码、文档等）的情况下弄清楚程序如何工作的过程。大多数游戏不会公开发布源代码，但可以通过分析游戏文件中的二进制数据来了解和重建游戏的许多细节。</p><p>对游戏进行逆向工程有几个原因：</p><h3 id="游戏知识">游戏知识</h3><p>游戏隐藏了许多有关其机制和实现的细节，游戏中的经验实验只能让你走这么远。进入逆向工程，你可以分析游戏的代码并准确了解游戏的工作原理。有了足够的游戏知识，人们可以运用这些知识来构建有用的工具，例如<a target="_blank" rel="noopener" href="https://calc.pokemonshowdown.com/">宝可梦战斗伤害计算器</a>，乃至<a target="_blank" rel="noopener" href="https://pokemonshowdown.com/">战斗模拟器</a>。</p><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/damage-calculator.png" alt="伤害计算器背后是一个复杂的公式，通过逆向工程发现。"><figcaption aria-hidden="true">伤害计算器背后是一个复杂的公式，通过逆向工程发现。</figcaption></figure><h3 id="打mod-破解">打<hl></hl>Mod / 破解</h3><p>在没有内置关卡编辑器的情况下，如何在游戏中构建自定义关卡、创建可让你无限飞行的作弊代码或为角色提供自定义的搞笑武器？大多数情况下，人们会对游戏进行逆向工程，最终搞明白如何修改游戏代码以添加这些功能。作弊代码（即<hl></hl>GameShark<hl></hl>和<hl></hl>Action Replay<hl></hl>等设备的作弊代码）也需要逆向工程来创建；作弊代码只是一组用于作弊设备的加密指令，为了修改内存或将少量代码注入游戏。</p><h3 id="利用游戏漏洞">利用游戏漏洞</h3><p>有一类漏洞被称为任意代码执行 (Arbitrary Code Execution, ACE)，它允许玩家将代码注入游戏，以执行硬件支持的几乎所有操作。包括无限物品、立即跳转到片尾字幕，甚至<a target="_blank" rel="noopener" href="https://youtu.be/Ukq29ePnTqI?t=2818">将<hl></hl>SNES<hl></hl>变成<hl></hl>Skype<hl></hl>视频聊天</a>。 ACE<hl></hl>需要对游戏代码有详细的了解才能充分利用，而逆向工程在设计这些漏洞方面起着重要作用。</p><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/skhype.png" alt="一台运行《塞尔达传说：众神的三角力量》的普通SNES。存在大量漏洞和ACE。"><figcaption aria-hidden="true">一台运行《塞尔达传说：众神的三角力量》的普通<hl></hl>SNES。存在大量漏洞和<hl></hl>ACE。</figcaption></figure><h3 id="解包获得情报">解包获得情报</h3><p>在内容定期更新的游戏中，开发人员有时会在游戏正式发布之前将新的游戏资源添加到游戏中。早期发布的演示版本还可能隐藏着完整游戏的部分内容。对游戏进行逆向工程以提取这些资源，并在正式发布之前了解新内容。</p><h2 id="配置逆向工程环境">配置逆向工程环境</h2><p>需要首先准备好以下软件：</p><ul><li><a target="_blank" rel="noopener" href="https://ghidra-sre.org/">Ghidra</a> - 用于静态代码分析的逆向工程工具。</li><li><a target="_blank" rel="noopener" href="http://desmume.org/">DeSmuME</a> - 具有调试和内存查看功能的<hl></hl>NDS<hl></hl>模拟器。</li><li>《宝可梦不可思议的迷宫：空之探险队》的<hl></hl>ROM - 我们将要逆向工程的游戏。请确保使用游戏的<hl></hl>USA/NTSC<hl></hl>版本；其他版本如<hl></hl>EU/PAL<hl></hl>版本数据和功能的位置不同。</li></ul><blockquote><p>本教程使用<hl></hl>DeSmuME<hl></hl>作为首选的<hl></hl>NDS<hl></hl>模拟器，但值得一提的是另一个常用于调试的<hl></hl>NDS<hl></hl>模拟器<hl></hl>[No<span class="math inline">\(GBA](https://www.nogba.com/)。No\)</span>GBA<hl></hl>具有比<hl></hl>DeSmuME<hl></hl>更高级的调试功能，但稳定性较差且用户不友好。</p></blockquote><p>只有<hl></hl>Windows<hl></hl>版本的<hl></hl>DeSmuME<hl></hl>具有适当的逆向工程调试功能。不幸的是，对于<hl></hl>macOS/Linux<hl></hl>用户来说，在这些操作系统上调试<hl></hl>NDS<hl></hl>游戏的唯一选择是<hl></hl>DeSmuME<hl></hl>部分功能的<hl></hl><a target="_blank" rel="noopener" href="https://www.sourceware.org/gdb/">gdb</a> stub，即使你熟悉<hl></hl>gdb，它也无法很好地工作。Ghidra<hl></hl>与所有操作系统兼容，因此如果你愿意，你可以选择在<hl></hl>macOS/Linux<hl></hl>上使用<hl></hl>Ghidra<hl></hl>并在<hl></hl>Windows<hl></hl>上使用<hl></hl>DeSmuME。或者，你可以按照本教程的<hl></hl><a target="_blank" rel="noopener" href="https://www.starcubelabs.com/reverse-engineering-gba">GBA<hl></hl>版</a>进行操作，因为有运行在<hl></hl>macOS/Linux<hl></hl>上且支持调试的<hl></hl>GBA<hl></hl>模拟器。</p><blockquote><p>以下<hl></hl>Ghidra<hl></hl>配置教程改编自<hl></hl>UsernameFodder<hl></hl>的出色指南，出自<hl></hl><a target="_blank" rel="noopener" href="https://github.com/UsernameFodder/pmdsky-debug/blob/master/docs/ghidra-setup.md">pmdsky-debug</a><hl></hl>项目。</p></blockquote><h3 id="解压rom">解压<hl></hl>ROM</h3><p>要开始分析<hl></hl>NDS<hl></hl>的<hl></hl>ROM，首先需要解压以提取游戏代码的二进制文件。要解压<hl></hl>ROM，可以使用<hl></hl><a target="_blank" rel="noopener" href="https://projectpokemon.org/home/files/file/2118-dslazy/">DSLazy</a>（Windows）或<hl></hl><a target="_blank" rel="noopener" href="https://github.com/devkitPro/ndstool">ndstool</a>（macOS/Linux）。</p><h4 id="使用dslazy">使用<hl></hl>DSLazy</h4><ol type="1"><li>下载<hl></hl><a target="_blank" rel="noopener" href="https://projectpokemon.org/home/files/file/2118-dslazy/">DSLazy</a><hl></hl>并解压<hl></hl>zip<hl></hl>文件。</li><li>运行<hl></hl>DSLazy<hl></hl>的可执行文件（<code>dslazy.exe</code>），启动程序。</li></ol><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/dslazy.png" alt="The DSLazy interface"><figcaption aria-hidden="true">The DSLazy interface</figcaption></figure><ol start="3" type="1"><li>单击<hl></hl>DSLazy<hl></hl>窗口左上角的<code>…</code>，然后在文件系统中选择《空之探险队》的<hl></hl>ROM<hl></hl>文件。</li><li>单击<hl></hl>nds unpack<hl></hl>按钮解压<hl></hl>ROM。这需要几秒钟才能完成。有时即使成功完成，DSLazy<hl></hl>也无法显示解压已完成。如果解压时间超过几秒钟，请检查下一步以查看文件是否已解压。</li><li>DSLazy<hl></hl>将打开文件资源管理器，其中包含一个包含解压文件的文件夹。此文件夹名为<hl></hl>“NDS_UNPACK”，位于<hl></hl>DSLazy<hl></hl>所在的文件夹中。</li></ol><h4 id="使用ndstool">使用<hl></hl>ndstool</h4><ol type="1"><li>下载<hl></hl><a target="_blank" rel="noopener" href="https://github.com/devkitPro/ndstool/releases/tag/v2.1.2">ndstool</a>（.tar.bz2<hl></hl>文件）并打开存档。</li><li>打开终端并<hl></hl>“cd”<hl></hl>到解压的<hl></hl>“ndstool-2.1.2”<hl></hl>文件夹，然后运行<hl></hl>“./configure &amp;&amp; make &amp;&amp; make install”。</li></ol><ul><li>根据你的权限，你可能需要运行<hl></hl>“sudo make install”<hl></hl>而不是<hl></hl>“make install”<hl></hl>以使用管理员权限运行安装。</li></ul><ol start="3" type="1"><li>创建一个文件夹来存储解压后的 ROM 文件，然后<hl></hl>“cd”<hl></hl>到该文件夹​​。</li><li>运行<hl></hl><code>ndstool -9 arm9.bin -7 arm7.bin -y9 y9.bin -y7 y7.bin -d data -y overlay -t banner.bin -h header.bin -x &lt;ROM path&gt;</code>，其中<hl></hl><code>&lt;ROM path&gt;</code><hl></hl>是文件系统上《空之探险队》的<hl></hl>ROM<hl></hl>的文件路径。ROM<hl></hl>将被解压到你创建的文件夹中。</li></ol><h3 id="设置ghidra">设置<hl></hl>Ghidra</h3><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/ghidra-ds.png" alt="用Ghidra分析函数"><figcaption aria-hidden="true">用<hl></hl>Ghidra<hl></hl>分析函数</figcaption></figure><p>Ghidra<hl></hl>是美国国家安全局（National Security Agency, NSA）开发的一款免费开源的逆向工程工具。Ghidra<hl></hl>可以分析游戏<hl></hl>ROM<hl></hl>等二进制数据、输出汇编代码、甚至反编译出<hl></hl>C<hl></hl>语言代码，我们可以根据这些代码对游戏进行逆向工程。这种分析是在游戏未运行的情况下进行的，所以被称为<strong>静态代码分析</strong>（相对于在游戏运行时调试的<strong>动态代码分析</strong>）。</p><blockquote><p>对业余爱好者来说，Ghidra<hl></hl>是理想的代码分析、反汇编工具，功能齐全且无需付费。Ghidra<hl></hl>也有付费替代品，作为逆向工程行业标杆的专业商业软件<hl></hl><a target="_blank" rel="noopener" href="https://hex-rays.com/ida-pro/">IDA</a>。不过，IDA<hl></hl>的完整版本售价数千美元，对许多业余爱好者来说都太贵了，而<hl></hl>IDA<hl></hl>的免费版本又没有足够的功能满足我们的需求。</p></blockquote><p>要安装<hl></hl>Ghidra，请按照<hl></hl><a target="_blank" rel="noopener" href="https://ghidra-sre.org/">Ghidra<hl></hl>官方网站</a>上的说明进行操作。</p><p>如果你使用的是较新版本的<hl></hl>macOS，则需要在设置项目之前授予<hl></hl>Ghidra<hl></hl>反编译器的运行权限。在<hl></hl>Ghidra<hl></hl>文件夹中，转到 <code>Ghidra/Features/Decompiler/os/mac_x86_64</code>，右键单击<hl></hl><code>decompile</code><hl></hl>可执行文件，选择<hl></hl><code>open</code>，并在<hl></hl>macOS<hl></hl>警告无法验证开发人员时确认<hl></hl><code>open</code>。</p><p>安装后启动<hl></hl>Ghidra，将看到以下页面。</p><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/ghidra-start.png" alt="Ghidra启动页面"><figcaption aria-hidden="true">Ghidra<hl></hl>启动页面</figcaption></figure><h3 id="创建ghidra项目">创建<hl></hl>Ghidra<hl></hl>项目</h3><p>使用解压缩的《空之探险队》ROM<hl></hl>文件来创建一个新项目。</p><ol type="1"><li>File &gt; New Project…</li><li>项目默认设置为<hl></hl>“Non-Shared Project”。点击<hl></hl>Next。</li><li>选择项目名称和保存项目的目录，然后点击<hl></hl>Finish。</li><li>File &gt; Import File…</li><li>从解压缩的<hl></hl>ROM<hl></hl>文件中选择<hl></hl>arm9.bin<hl></hl>文件。</li><li>为<hl></hl>Ghidra<hl></hl>选择一个指令集架构（Language）来分析该二进制文件。NDS<hl></hl>使用<hl></hl>ARMv5T（具体来说是<hl></hl>ARMv5TE）指令集，采用小端序（<strong>ARM:LE:32:v5t</strong>），你可以通过在<hl></hl>language<hl></hl>选择中搜索<hl></hl>“v5t”<hl></hl>找到，然后选择<hl></hl>Endian<hl></hl>列下带有<hl></hl>“little”<hl></hl>的选项。</li></ol><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/armv5t.png" alt="选择 ARMv5T 语言"><figcaption aria-hidden="true">选择 ARMv5T 语言</figcaption></figure><ol start="7" type="1"><li><p>点击<hl></hl>Options…并将基址（Base Address）设置为<hl></hl>02000000。</p></li><li><p>点击<hl></hl>OK<hl></hl>让<hl></hl>Ghidra<hl></hl>检查该二进制文件。</p></li><li><p>完成后，Ghidra<hl></hl>会显示一些检查细节的报告。点击<hl></hl>OK<hl></hl>继续。</p></li><li><p>双击<hl></hl>Ghidra<hl></hl>中的<hl></hl>ROM<hl></hl>来打开<hl></hl>Ghidra<hl></hl>的代码查看器。</p></li><li><p>Ghidra<hl></hl>会提醒是否分析二进制文件。暂时点击<hl></hl>No，因为还要做一些设置。</p><blockquote><p>如果此时运行分析，也不会造成任何不良影响。Ghidra<hl></hl>只是会根据现有信息进行部分分析，稍后可以在一切都设置好之后重新运行分析。</p></blockquote></li><li><p>点击<hl></hl>File &gt; Add To Program，然后在解压缩的<hl></hl>ROM<hl></hl>文件中查找<hl></hl><code>overlays</code><hl></hl>文件夹。选择该文件夹中的<hl></hl><code>overlay_0029.bin</code>。</p></li><li><p>点击<hl></hl>Options…</p></li><li><p>将块名称设置为<hl></hl>“overlay_0029.bin”。</p><blockquote><p>块名称不会影响分析，实际上可以是任何名称。不过我建议使用与<hl></hl>overlay<hl></hl>文件相同的名称以便于跟踪。</p></blockquote></li><li><p>将基址设置为<hl></hl>22DC240。</p></li><li><p>点击<hl></hl>OK<hl></hl>确认你设置的选项，点击<hl></hl>OK<hl></hl>添加<hl></hl>overlay，然后当<hl></hl>Ghidra<hl></hl>显示添加完成时再点击<hl></hl>OK。</p><blockquote><p>你可能注意到选项中有一个<hl></hl>Overlay<hl></hl>复选框，但对现在来说没啥用。请保持未选中状态以避免干扰<hl></hl>Ghidra<hl></hl>的分析。</p></blockquote></li><li><p>使用<hl></hl>overlay<hl></hl>文件 <code>overlay_0010.bin</code><hl></hl>重复步骤<hl></hl>12-16。使用<hl></hl>22BCA80<hl></hl>作为该文件的基址。</p></li><li><p>使用<hl></hl>overlay<hl></hl>文件 <code>overlay_0031.bin</code><hl></hl>重复步骤<hl></hl>12-16。使用<hl></hl>2382820<hl></hl>作为该文件的基址。</p></li><li><p>通过选择 <code>Analysis &gt; Auto Analyze ‘&lt;project&gt;’…</code> 运行分析，或使用热键 ‘a’。</p></li><li><p>使用默认的分析设置并点击<hl></hl>Analyze。</p></li><li><p>等待<hl></hl>Ghidra<hl></hl>分析二进制文件。这可能需要几分钟。</p></li><li><p>当<hl></hl>Ghidra<hl></hl>的分析完成后，验证<hl></hl>Ghidra<hl></hl>是否正确设置。按<hl></hl>‘g’，输入<hl></hl>“22E0354”，然后按<hl></hl>OK。你应该会看到如下页面。此时，Ghidra<hl></hl>已经设置完成，可以开始逆向工程游戏。</p></li></ol><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/ghidra-setup-ds.png" alt="Ghidra设置后的自动分析功能"><figcaption aria-hidden="true">Ghidra<hl></hl>设置后的自动分析功能</figcaption></figure><h4 id="设置步骤解惑">设置步骤解惑</h4><p>如果我不告诉你，你咋知道要选<hl></hl>ARM:LE:32:v5t？</p><p>首先，搜索<hl></hl>NDS<hl></hl>用的是哪款<hl></hl>CPU（例如，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Nintendo_DS">维基百科</a>），然后你就会发现<hl></hl>NDS<hl></hl>使用两颗<hl></hl>CPU<hl></hl>分别是<hl></hl>ARM946E-S<hl></hl>和<hl></hl>ARM7TDMI。从<hl></hl>NDS<hl></hl>的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Nintendo_DS#Technical_specifications">技术规格</a>可以知道，NDS<hl></hl>的<hl></hl>ARM9 CPU<hl></hl>是用于游戏机制（gameplay mechanisms）的那颗<hl></hl>CPU。知道了<hl></hl>CPU<hl></hl>信息，你就可以搜到<hl></hl>CPU<hl></hl>的指令集和架构。<a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0201/d/introduction/about-the-arm946e-s-processor">ARM<hl></hl>的文档</a>说<hl></hl>ARM946E-S<hl></hl>用的是<hl></hl>ARMv5TE<hl></hl>架构。这意味着<hl></hl>ARMv5T<hl></hl>就是我们要找的东西。“ARMv5TE”<hl></hl>里的后缀<hl></hl>“E”<hl></hl>表示支持额外的信号处理指令，不过你不需要关心这些指令。</p><p>至于<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Endianness">端序（endianness）</a>（数据中每个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Word_(computer_architecture)">字（word）</a> 的字节存储顺序），大多数<hl></hl>ARM CPU<hl></hl>都是<hl></hl>“双端”<hl></hl>的：同时支持小端和大端。实际操作中，大多数<hl></hl>ARM<hl></hl>程序都是小端的。如果<hl></hl>Ghidra<hl></hl>用小端序逆向出的反汇编代码难以理解，请尝试大端，看看输出的代码是否有所改善。需要注意的是，某些<hl></hl>CPU（例如使用<hl></hl><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PowerPC">PowerPC</a><hl></hl>指令集的<hl></hl>CPU（例如 Wii））主要采用大端序。</p><p>项目设置在添加<hl></hl>overlay<hl></hl>时会使用一些魔数（magic numbers，没有任何文档或注释的数字，但凡开发者搞不明白为什么是这个数的都叫魔法——译注）。本教程稍后将讨论<hl></hl>overlay，包括如何自行找到这些数字。</p><p>有些游戏会压缩<hl></hl><code>arm9.bin</code><hl></hl>和覆盖文件，可以使用<a target="_blank" rel="noopener" href="https://www.romhacking.net/utilities/826/">这个工具</a>解压。在《空之探险队》中，汇编文件未经压缩，因此你无需担心解压问题。</p><h3 id="设置desmume以运行空之探险队">设置<hl></hl>DeSmuME<hl></hl>以运行《空之探险队》</h3><p>设置好<hl></hl>Ghidra<hl></hl>之后，你还需要设置<hl></hl>NDS<hl></hl>模拟器，然后过掉游戏开场动画。</p><ol type="1"><li>从<hl></hl><a target="_blank" rel="noopener" href="http://desmume.org/download/">DeSmuME<hl></hl>网站</a>下载<hl></hl>DeSmuME<hl></hl>的最新稳定版本，并解压到心仪的文件夹中。</li><li>打开<hl></hl>DeSmuME，转到<hl></hl>File &gt; Open ROM…，然后在文件系统中选择《空之探险队》的<hl></hl>ROM。确保使用原始<hl></hl>ROM（.nds）文件，而不是从中解压的文件。</li><li>如果需要，请在<hl></hl>Config &gt; Control Config<hl></hl>查看和配置按钮映射。</li><li>观看游戏的介绍过场动画，然后开始新游戏。</li><li>游戏开始时有一个个性测验，它将决定你的玩家角色。回答问题，无论诚实与否，游戏都会为你分配一只神奇宝贝。</li><li>为自己、伙伴宝可梦和伙伴选择一个名字。</li><li>决定玩家和伙伴宝可梦后，你将进入过场动画。过场动画结束后，你将进入游戏的第一个迷宫，Beach Cave。</li><li>进入<hl></hl>Beach Cave<hl></hl>后，你就可以对游戏进行逆向工程了。</li></ol><figure><img loading="lazy" src="/notes/images/nds-reverse-engineering/desmume-setup.png" alt="《空之探险队》设置完的样子。"><figcaption aria-hidden="true">《空之探险队》设置完的样子。</figcaption></figure><p>设置好<hl></hl>Ghidra<hl></hl>和游戏后，下一步就是打开游戏并阅读代码。你需要知道如何阅读汇编代码，下一节就将介绍。</p><p class="fin text-indent-none"><a href="/notes/2024/10/02/%E5%A6%82%E4%BD%95%E9%80%86%E5%90%91NDS%E6%B8%B8%E6%88%8F%EF%BC%88%E4%B8%8B%EF%BC%89/">to <span style="color:blue">B</span><span style="color:red">e</span> continued -&gt;</a></p></div></article><aside class="post-widget"><h4>目录<hl></hl></h4><nav class="post-toc-wrap" id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%B3%E4%BA%8E%E6%9C%AC%E6%95%99%E7%A8%8B"><span class="post-toc-number">1.</span> <span class="post-toc-text">关于本教程<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%B7%9F%E9%9A%8F%E6%9C%AC%E6%95%99%E7%A8%8B%E9%9C%80%E8%A6%81%E4%BB%80%E4%B9%88%E6%8A%80%E8%83%BD"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">跟随本教程需要什么技能？</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B"><span class="post-toc-number">2.</span> <span class="post-toc-text">什么是逆向工程<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B8%B8%E6%88%8F%E7%9F%A5%E8%AF%86"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">游戏知识<hl></hl></span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%89%93mod-%E7%A0%B4%E8%A7%A3"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">打<hl></hl>Mod / 破解<hl></hl></span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A9%E7%94%A8%E6%B8%B8%E6%88%8F%E6%BC%8F%E6%B4%9E"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">利用游戏漏洞<hl></hl></span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%A7%A3%E5%8C%85%E8%8E%B7%E5%BE%97%E6%83%85%E6%8A%A5"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">解包获得情报<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E7%8E%AF%E5%A2%83"><span class="post-toc-number">3.</span> <span class="post-toc-text">配置逆向工程环境<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%A7%A3%E5%8E%8Brom"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">解压<hl></hl>ROM</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8dslazy"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">使用<hl></hl>DSLazy</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8ndstool"><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">使用<hl></hl>ndstool</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AE%BE%E7%BD%AEghidra"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">设置<hl></hl>Ghidra</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%9B%E5%BB%BAghidra%E9%A1%B9%E7%9B%AE"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">创建<hl></hl>Ghidra<hl></hl>项目<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%AD%A5%E9%AA%A4%E8%A7%A3%E6%83%91"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">设置步骤解惑<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AE%BE%E7%BD%AEdesmume%E4%BB%A5%E8%BF%90%E8%A1%8C%E7%A9%BA%E4%B9%8B%E6%8E%A2%E9%99%A9%E9%98%9F"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">设置<hl></hl>DeSmuME<hl></hl>以运行《空之探险队》</span></a></li></ol></li></ol></nav></aside></div><footer class="footer-nav"><div class="footer"><div class="back-top" id="back-top" title="Back to top"><i class="icon icon-chevron-bar-up"></i></div><div class="footer-content"><div class="footer-links"><div class="footer-links-column"><p><a title="Google Scholar" target="_blank" rel="noopener" href="https://scholar.google.com/">Google Scholar</a></p><p><a title="Google patents" target="_blank" rel="noopener" href="https://patents.google.com/">Google patents</a></p><p><a title="Bing Academic" target="_blank" rel="noopener" href="https://bing.com/academic/">Bing Academic</a></p></div><div class="footer-links-column"><p><a title="Web of Science" target="_blank" rel="noopener" href="https://www.webofscience.com/">Web of Science</a></p><p><a title="Science Direct" target="_blank" rel="noopener" href="https://www.sciencedirect.com/">Science Direct</a></p><p><a title="中国知网" target="_blank" rel="noopener" href="https://www.cnki.net/"><hl></hl>中国知网<hl></hl></a></p></div><div class="footer-links-column"><p><a title="arXiv" target="_blank" rel="noopener" href="https://arxiv.org/">arXiv</a></p><p><a title="JSTOR" target="_blank" rel="noopener" href="https://www.jstor.org/">JSTOR</a></p><p><a title="PubMed Central" target="_blank" rel="noopener" href="https://www.ncbi.nlm.nih.gov/pmc/">PubMed Central</a></p></div><div class="footer-links-column"><p><a title="MSI Eureka" target="_blank" rel="noopener" href="https://search.msi-eureka.com/search">MSI Eureka</a></p><p><a title="GitHub" target="_blank" rel="noopener" href="https://github.com/cerallin/">GitHub</a></p><p><a title="KUKE音乐" target="_blank" rel="noopener" href="https://www.kuke.com/">KUKE<hl></hl>音乐</a></p></div></div><div><span id="site_pv">?</span> PV <span id="site_uv">?</span> UV</div>Copyright © 2021<span class="time-divide">-</span>2026 Cerallin. Power by <a href="https://hexo.io/" target="_blank" rel="external nofollow">Hexo</a> and <a href="https://github.com/Cerallin/hexo-theme-yuzu" target="_blank" rel="external nofollow" title="v3.2.7">Theme Yuzu</a>.</div></div></footer><script>window.config={url_root:"/notes/",meta_path:"meta.json"}</script><script src="/notes/js/theme/back-to-top.js"></script><script src="/notes/js/theme/clipboard.js"></script><script src="/notes/js/theme/loading.js"></script><script src="/notes/js/theme/navbar.js"></script><script src="/notes/js/theme/search.js"></script><script src="/notes/js/theme/toc.js"></script><script src="/notes/js/theme/refs-sidebar.js"></script><script>window.onload=function(){for(var e in Theme)Theme[e].register()}</script></div><div class="search-modal" id="search-modal"><div class="card"><div class="card-head"><div class="search-box"><input class="search-input" id="search-input" placeholder="搜索"><div class="search-button" id="search-button"><div class="icon icon-search"></div></div></div><div class="close-button"><div class="icon icon-x"></div></div></div><div class="card-body"><div class="search-count">共<hl></hl><span id="search-count-num">0</span><hl></hl>条搜索结果。</div><div class="search-result" id="search-result"></div></div></div></div></body></html>