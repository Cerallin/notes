<html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="这篇文章介绍了Nintendo DS的硬件架构与设计，涵盖了CPU、内存、图形、音频等各子系统的特性和实现方法，并对其创新与限制进行了详细分析。文章还探讨了开发生态、反盗版机制及自制游戏的破解历程，并回顾了这一掌机对游戏开发者和玩家的深远影响。最后，作者结合实例对NDS的工程设计与实际表现进行了客观评价。"><title>NDS架构简要分析 - Cerallin的笔记本 - 瞎折腾～～</title><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="/notes/css/style.css"><link rel="stylesheet" href="/notes/css/helpers.css"><script src="/notes/js/clipboard/clipboard.min.js"></script><script src="/notes/js/bootstrap.js"></script><script>Theme.counter={register:function(){request("//visitor-counter.cerallin.top/count.php/?page="+encodeURI(window.location.href),{method:"GET"}).then(e=>{for(var t in e){var n=document.getElementById(t);n&&(n.innerText=e[t])}}).catch(e=>{console.error("Fetching visit count failed.",e)})}}</script><style>body hl:after {
    content: ' ';
    display: inline;
    font-family: inherit;
    font-size: 0.45em;
}

html code hl,
html pre hl,
html kbd hl,
html samp hl,
html ruby hl,
html .tag-list-item hl {
    display: none;
}

html ol > hl,
html ul > hl {
    display: none;
}</style><meta name="generator" content="Hexo 8.1.1"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}</style><link rel="alternate" href="/notes/atom.xml" title="Cerallin的笔记本" type="application/atom+xml"></head><body><div class="loading-wrapper" data-loading="data-loading"><div class="loading"><span></span><span></span><span></span></div></div><div class="page" data-filter="data-filter"><div class="head" data-show="data-show"><header class="head-header"><div class="head-author"><a class="head-author-link" href="/notes/">Cerallin<hl></hl>的笔记本</a></div><div class="head-right"><button class="bar-wrap" id="bar-wrap-toggle" title="菜单按钮"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button><div class="head-item"><a class="search-button head-item-link"><span>搜索</span> <i class="icon icon-search"></i></a></div><div class="head-item"><a class="head-item-link" href="/notes/about">关于</a></div></div></header><div class="menubar-head" id="menubar"><ul class="menubar-ul"><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%8E%E9%80%9A%E4%BF%A1%E5%B7%A5%E7%A8%8B/">计算机与通信工程</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E6%9D%90%E6%96%99%E7%A7%91%E5%AD%A6%E4%B8%8E%E5%B7%A5%E7%A8%8B/">材料科学与工程</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/">瞎折腾</a></li><li class="menubar-item"><i class="icon icon-chevron-right"></i> <a class="menubar-link" href="/notes/categories/%E6%B5%85%E6%80%9D/">浅思</a></li><li class="menubar-item" data-border="data-border"></li><li class="menubar-item"><i class="icon icon-archive"></i> <a class="menubar-link" href="/notes/archives">归档</a></li><li class="menubar-item"><i class="icon icon-tags"></i> <a class="menubar-link" href="/notes/tags">标签</a></li><li class="menubar-item" data-border="data-border"></li><li class="menubar-item"><a class="menubar-link" href="/notes/about"><span>关于</span></a></li></ul><div class="menu-search-box search-button"><div>搜索</div><i class="icon icon-search"></i></div></div></div><div class="main" data-page="post"><article class="post" id="post"><header class="post-head"><h1 class="post-title"><a class="title" href="/notes/2023/03/10/NDS%E6%9E%B6%E6%9E%84%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/">NDS<hl></hl>架构简要分析<hl></hl></a></h1></header><div class="post-meta"><div class="post-date"><time class="post-time" itemprop="datePublished" title="2023-03-10 17:12:55" datetime="2023-03-10T09:12:55.000Z">2023-03-10</time></div>|<div class="post-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/Nintendo-DS/" rel="tag">Nintendo DS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/notes/tags/%E6%B8%B8%E6%88%8F%E4%B8%BB%E6%9C%BA/" rel="tag"><hl></hl>游戏主机</a></li></ul></div><div class="post-visit"><span id="page_pv">?</span><hl></hl>访问</div></div><div class="post-info"><div class="post-word-count">本文共<hl></hl>12,975<hl></hl>字。</div><div class="post-cc">版权声明：署名 | <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div><div class="article-entry" itemprop="articleBody"><style>#post figure img {
    width: 50%;
    margin-left: 25%;
  }
  #post figure figcaption {
    width: 50%;
  }

  #post .column-2 {
    display: grid;
    grid-template-columns: 45% 45%;
    grid-column-gap: 10%;
    width: 80%;
    margin-left: 10%;
  }
  #post .column-2 img, #post .column-2 figcaption {
    width: 100%;
    margin: 0;
  }
  #post .column-3 {
    display: grid;
    grid-template-columns: 30% 30% 30%;
    grid-column-gap: 5%;
    width: 80%;
    margin-left: 10%;
  }
  #post .column-3 img, #post .column-3 figcaption {
    width: 100%;
    margin: 0;
  }</style><blockquote><p>原文标题：Nintendo DS Architecture - A Practical Analysis<span class="citation" data-cites="copetti-nintendods">[<a href="#ref-copetti-nintendods" role="doc-biblioref">1</a>]</span>。原作者：Rodrigo Copetti，译：Cerallin（我自己）。</p></blockquote><span id="more"></span><h3 id="译者序">译者序</h3><p>两个月以来我一直在开发<hl></hl>NDS<hl></hl>的自制游戏，从零开始。当初这篇文章带我入门了<hl></hl>NDS<hl></hl>的底层架构，除<hl></hl>libnds<hl></hl>的文档外，就属这篇文章对我帮助最深。每当我想放弃时就来看看，然后就会发现自己之前思路的错误之处，就又能继续下去了。</p><p>为了让更多的人看到这篇充满希望（？）的文章，这周我花时间翻译了一下。没想到很快就翻译完了。原网站不久就会把我的翻译部署上去吧，在那之前，我先水篇博客（</p><p>实际上国内也不乏神贴，例如<hl></hl><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/245264038">NDS<hl></hl>平台破解<hl></hl>&amp;<hl></hl>烧录史</a>。但这些文章一般从玩家的角度考察<hl></hl>NDS<hl></hl>世界，自制游戏开发者视角的文档少之又少。想来国内就没有<hl></hl>NDS<hl></hl>自制游戏的土壤，因为<hl></hl>NDS<hl></hl>不算正式进入过中国市场，极客们都去搞破解汉化和改版去了。时至今日我才试探<hl></hl>NDS<hl></hl>编程，应该算是逆时代而行了。</p><p>总而言之，本文讨论的范围甚广，对于自制游戏来说，很多细节还需要我自己去深入研究。如果你想了解<hl></hl>NDS<hl></hl>运行的原理，那么这篇文章正适合你。如果好奇<hl></hl>PC<hl></hl>以外的计算机的架构，也可以看看原作者该系列的其他文章。如果觉得本文对你有所帮助，可以去<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-ds/#contributing">原文网址底部捐赠</a>，或<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/materials/ebook/">购买电子书</a>。</p><p>顺便一提，本译文遵循<hl></hl>CC 4.0<hl></hl>协议。虽然本网站的全部文章都有版权声明四个字，但还是强调一下。</p><h3 id="快速入门">快速入门</h3><p>这款游戏机回应了掌机生态中无法满足的许多需求，有一些创新也有一些妥协，不过这种组合可能会为新颖而独创的内容铺平道路。</p><hr><h3 id="cpu">CPU</h3><p>和任天堂的<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance">上一代掌机</a>一样，NDS<hl></hl>的系统围绕一个名为<hl></hl><strong>CPU NTR</strong> 的大芯片展开。其中<hl></hl>“NTR”<hl></hl>是<hl></hl>“Nitro”<hl></hl>的缩写，是最初的<hl></hl>NDS<hl></hl>的代号。</p><p>CPU NTR<hl></hl>使用两个不同的<hl></hl>ARM CPU<hl></hl>实现了一个有趣的多处理器架构。在<hl></hl>ARM Holdings<hl></hl>正式发布多处理器解决方案之前这个设计就完成了。因此，考虑到当前的技术实现，可能有人认为<hl></hl>NDS<hl></hl>的多处理器架构不是很正统。</p><h4 id="设计">设计</h4><p>虽然这不是<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/consoles">本系列</a>第一次分析游戏机的并行系统，但是<hl></hl>NDS<hl></hl>的设计确与其他游戏机有很大不同。例如，NDS<hl></hl>的设计有别于<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/sega-saturn">世嘉土星<hl></hl></a>“实验性质”<hl></hl>的主从配置，也不同于<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/playstation">PS1</a><hl></hl>或者<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-64">N64</a><hl></hl>的<hl></hl>“协处理器”<hl></hl>方案。NDS<hl></hl>包括两台非常独立的计算机，可以分别独立执行操作。每台计算机都有一条专用的总线。这种设计方法被称为<strong>非对称多处理（Asymmetric multiprocessing）</strong>。 CPU<hl></hl>因此而相互依赖，并将左右这款游戏机的整体性能。</p><p>话是这么说，现在我们来看看这两个<hl></hl>CPU：</p><h5 id="arm7tdmi">ARM7TDMI</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/arm7_core.8a9851c20df1dda3c252ae75f544a8ce7a6749026fa4bc870027741cda1003b4.png" alt="ARM7 的结构与组成部分。"><figcaption aria-hidden="true">ARM7 的结构与组成部分。</figcaption></figure><p>首先说说我们较为熟悉的<hl></hl>CPU。<strong>ARM7TDMI</strong><hl></hl>与<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#cpu">GBA</a><hl></hl>的<hl></hl>CPU<hl></hl>相同，但现在运行速度提高到<strong>约<hl></hl>34 MHz</strong>（原速度的两倍）。它仍然包含所有原有功能（特别是<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#whats-new">Thumb</a>）。</p><p>然后讲讲新变化：由于任天堂的工程师将<hl></hl>ARM7<hl></hl>放置在大多数<hl></hl>I/O<hl></hl>端口旁边，这个<hl></hl>CPU<hl></hl>将负责调节和协助<hl></hl>I/O<hl></hl>操作。事实上，另一个处理器不能直接连接<hl></hl>I/O。如你所见，ARM7<hl></hl>不是负责整个系统的<hl></hl>“主”<hl></hl>处理器。它负责在多个组件之间传递数据，是用来分担一部分主<hl></hl>CPU<hl></hl>负载的<hl></hl>“子处理器”。</p><h5 id="arm946e-s">ARM946E-S</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/arm9_core.213329ca27287083c84d30b27fb9da63edd81998406a10b9ee7289089d0fe94d.png" alt="ARM9 的结构与组成部分。"><figcaption aria-hidden="true">ARM9 的结构与组成部分。</figcaption></figure><p>这是运行频率<strong>约<hl></hl>67 MHz</strong><hl></hl>的<hl></hl>“主”CPU。如果忽略掉时运不济的<hl></hl>ARM8<hl></hl>系列，可以认为<hl></hl>ARM946E-S<hl></hl>是<hl></hl>ARM7<hl></hl>的<hl></hl>“下一代”<hl></hl>处理器。作为<hl></hl><strong>ARM9<hl></hl>系列</strong>的一部分，它不仅继承了<hl></hl><strong>ARM7TDMI</strong><hl></hl>的所有特性，还包括一些额外的部分<hl></hl><span class="citation" data-cites="cpu-arm9reference">[<a href="#ref-cpu-arm9reference" role="doc-biblioref">2</a>]</span>：</p><ul><li><strong>ARMv5TEISA</strong>：与以前的<hl></hl>4<hl></hl>代相比，支持了一些新的指令，乘法器也更快。<ul><li>如果仔细观察核心的名称，字母<hl></hl>“E”<hl></hl>表示<strong>增强型（Enhanced）DSP</strong>。这意味着这些新指令大多与信号处理有关。</li></ul></li><li><strong>5<hl></hl>级流水线</strong>：与之前的<hl></hl>3<hl></hl>级流水线相比，这是另一个提升。</li><li><strong>12 KB L1 高速缓存</strong>：该核心新增有高速缓存，其中<hl></hl>8 KB<hl></hl>用于指令，4 KB<hl></hl>用于数据。</li><li><strong>48 KB<hl></hl>紧耦合存储器（Tightly-Coupled Memory, TCM）</strong>：类似于<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/playstation#cpu">Scratchpad<hl></hl>内存</a>，但该内存分别存储指令（32 KB）和数据（16 KB）。</li></ul><p>任天堂在<hl></hl>ARM9<hl></hl>周围还添加了以下组件：</p><ul><li>一个<strong>除法器和平方根单元</strong>，以加速这些类型的操作（ARM9<hl></hl>本身不能执行这种类型的数学计算）。</li><li>一个<strong>直接内存访问控制器（Direct Memory Access Controller, DMAC）</strong>：独立于<hl></hl>CPU<hl></hl>加速内存传输。结合使用高速缓存，CPU<hl></hl>和<hl></hl>DMA<hl></hl>有并发运行的潜力。<ul><li>缓存和<hl></hl>DMA<hl></hl>可以提供很多性能，但也会造成新的问题，如数据可靠性。开发者需要手动维护内存一致性，例如，先刷新<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/playstation-2#preventing-past-mishaps">write-buffer</a><hl></hl>然后再触发<hl></hl>DMA。</li></ul></li></ul><p>就<hl></hl>NDS<hl></hl>这硬件，也许不难发现孩子们喜欢这款游戏机的<em>真正</em>原因？</p><h4 id="互连">互连</h4><p>到目前为止，我已经介绍了这两个<hl></hl>CPU<hl></hl>如何单独工作。但是作为一个整体运行，它们需要不断合作。为了实现这一点，两个<hl></hl>CPU<hl></hl>直接使用专用的<hl></hl><strong>FIFO<hl></hl>单元<hl></hl></strong><span class="citation" data-cites="cpu-double">[<a href="#ref-cpu-double" role="doc-biblioref">3</a>]</span><hl></hl>进行<hl></hl>“对话”，该数据块包含两个<hl></hl>64<hl></hl>字节队列（最多<hl></hl>16<hl></hl>个元素），用于<strong>双向通信</strong>。</p><figure><img loading="lazy" src="/notes/images/copetti-nds/fifo.4c452b5f9236fb1e98454d2f90d2cab902ee4c561e165e8eaf8a8fc0cd7a05f4.png" alt="FIFO单元示意图。"><figcaption aria-hidden="true">FIFO<hl></hl>单元示意图。</figcaption></figure><p>具体工作方式如下：发送方<hl></hl>CPU（发送消息的<hl></hl>CPU）将一个<hl></hl>32<hl></hl>位数据块放入队列中，接收方<hl></hl>CPU<hl></hl>可以从队列中拉取该块并对其执行所需的操作。</p><p>每当队列上写入一个值，它可以被任一<hl></hl>CPU<hl></hl>主动获取（<strong>轮询</strong>），但这需要不间断地检查新消息（开销会很大）。或者，也可以激活一个<strong>中断单元</strong>，以便在队列中有新消息时通知接收方。</p><h4 id="主存储器">主存储器</h4><p>就像<hl></hl>GBA<hl></hl>一样，NDS<hl></hl>的<hl></hl>RAM<hl></hl>也被分散在许多不同的位置，以便根据访问速率来安排数据远近。总之，可用通用内存如下：</p><figure><img loading="lazy" src="/notes/images/copetti-nds/ram.99e9bd12e464182ef51ea4aa89a7fc60323a46a72550afbacd737957372cf190.png" alt="该掌机的RAM模型。"><figcaption aria-hidden="true">该掌机的<hl></hl>RAM<hl></hl>模型。</figcaption></figure><ul><li><strong>32<hl></hl>位</strong>总线的<hl></hl><strong>32 KB WRAM</strong>（Work RAM）：用于存储在<hl></hl>ARM7<hl></hl>和<hl></hl>ARM9<hl></hl>之间共享的快速数据。<ul><li>请记住，同一地址一次只能由一个 CPU 访问。</li></ul></li><li><strong>32<hl></hl>位</strong>总线的<hl></hl><strong>64 KB WRAM</strong>：同样用于快速数据，但只能从<hl></hl>ARM7<hl></hl>访问，就像<hl></hl>GBA<hl></hl>一样。</li><li><strong>16<hl></hl>位</strong>总线的<hl></hl><strong>4 MB PSRAM</strong>：速度较慢，可以由任一<hl></hl>CPU<hl></hl>访问，由内存接口单元控制。<ul><li>伪静态随机存取存储器（Pseudo SRAM, PSRAM）是<hl></hl>DRAM<hl></hl>的一种变种，与<hl></hl>DRAM<hl></hl>相比，PSRAM<hl></hl>芯片自己就能执行刷新操作。因此，它的行为类似于 SRAM（DRAM<hl></hl>的一种替代品，更快但更昂贵）。这种设计让我想起了<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/gamecube#clever-memory-system">1T-SRAM</a>。</li></ul></li></ul><h4 id="向后兼容性">向后兼容性</h4><p>尽管架构与前代有很大不同，但<hl></hl>NDS<hl></hl>仍成功地保留了关键部分，从而原生支持<hl></hl>GameBoy Advance (GBA)<hl></hl>游戏。</p><p>但是，为了将<hl></hl>NDS<hl></hl>转为<hl></hl>“内部”GBA，前者包括一组软件例程（software routines），可以将游戏机设置为<hl></hl><strong>AGB<hl></hl>兼容模式（AGB Compatibility Mode）</strong>。此过程中，实际上会终止<hl></hl>ARM9，禁用大部分<hl></hl>“特殊”<hl></hl>硬件，重定向总线，将<hl></hl>ARM7<hl></hl>置于控制位置，并将其频率降至<hl></hl>16.78 MHz。最后，ARM7<hl></hl>开始引导初始的<hl></hl>AGB BIOS，该<hl></hl>BIOS<hl></hl>引导<hl></hl>GamePak<hl></hl>卡带（就像本来的<hl></hl>GBA<hl></hl>一样）。这种模式仍然展示出一些<hl></hl>GBA<hl></hl>所没有的特征，例如游戏显示时有黑边框（在下一节中我们将看到新屏幕分辨率恰好更大）。此外，由于<hl></hl>NDS<hl></hl>有两个屏幕，所以用户可以设置用哪个屏幕显示<hl></hl>GBA<hl></hl>游戏。</p><p>一旦进入<hl></hl>GBA<hl></hl>模式，就<strong>没有退路</strong>了，必须重置游戏机才能重新激活其余硬件。</p><h4 id="秘密和限制">秘密和限制</h4><p>单个廉价芯片中安装了这么多复杂组件，强制他们协作导致出了一些问题，这并不是什么神秘的事情。</p><h5 id="性能阉割">性能阉割</h5><p>有时候我真想知道任天堂计划如何使用这两个<hl></hl>CPU，以及他们是否清楚这种设计会损失一些性能。</p><p>让我们从<hl></hl>ARM9<hl></hl>开始。该<hl></hl>CPU<hl></hl>的运行速度是<hl></hl>ARM7<hl></hl>的两倍，但大部分（甚至是全部）的<hl></hl>I/O<hl></hl>都依赖于<hl></hl>ARM7。因此等待<hl></hl>ARM7<hl></hl>的响应可能导致<hl></hl>ARM9<hl></hl>频繁阻塞。不仅如此，<strong>ARM9<hl></hl>的外部总线速度只有一半</strong>，因此存在一些瓶颈问题。</p><p>此外，主存储器总线只有<hl></hl><strong>16<hl></hl>位</strong>。无论哪个<hl></hl>CPU<hl></hl>需要从存储器中提取一个字（32<hl></hl>位宽），接口都会<strong>阻塞<hl></hl>CPU</strong>，然后占用高达<hl></hl>3<hl></hl>个<hl></hl>“等待”<hl></hl>周期，直到拼成一个完整的字。内存访问不连续时影响最严重，每次内存访问都会阻塞。这个问题在指令获取时也会出现。不幸的是，当时的<hl></hl>ARM<hl></hl>不支持顺序操作码获取（sequential opcode fetching），这也影响到了<hl></hl>Thumb<hl></hl>指令（因为每次获取<hl></hl>16<hl></hl>位数据都要以<hl></hl>32<hl></hl>位的块为单位进行）。另一方面，这个一些资料所谓的<hl></hl>“penalty”，可以充分利用缓存和<hl></hl>TCM<hl></hl>来缓解。</p><p>总的来说，这意味着在最坏的情况下，这款<hl></hl>“猛烈”<hl></hl>的<hl></hl>ARM9 66 MHz<hl></hl>的处理能力实际上会被降低到只有约<hl></hl>8 MHz，如果程序的缓存<hl></hl>/TCM<hl></hl>的利用率极低的话。</p><p>如果需要详细报告，我建议查看<hl></hl>Martin Korth<hl></hl>的文档<hl></hl><span class="citation" data-cites="cpu-korth">[<a href="#ref-cpu-korth" role="doc-biblioref">4</a>]</span>，尤其是<hl></hl>“DS Memory Timings”<hl></hl>一节。</p><h5 id="关于硬件选择的问题">关于硬件选择的问题</h5><p>当初研究<hl></hl>GBA<hl></hl>的<hl></hl>CPU<hl></hl>时，我对<hl></hl>ARM7<hl></hl>的潜力感到非常惊讶：该<hl></hl>CPU<hl></hl>不仅可以完成设计之内的任务，还可以协助完成其他任务，例如提供音频序列或伪<hl></hl>3D<hl></hl>图形。</p><p>与此相关的是，在商业化<hl></hl>ARM7<hl></hl>的过程中，ARM Holdings<hl></hl>与<hl></hl>DEC<hl></hl>合作设计了<hl></hl>ARM<hl></hl>芯片的高端版本。为此，DEC<hl></hl>采用了他们的<hl></hl><strong>Alpha</strong><hl></hl>处理器的数据通路设计，并结合了<hl></hl>ARM<hl></hl>的设计<hl></hl><span class="citation" data-cites="cpu-jaggar">[<a href="#ref-cpu-jaggar" role="doc-biblioref">5</a>]</span>。研发出的一系列名为<hl></hl><strong>StrongARM</strong><hl></hl>的新<hl></hl>CPU，速度<em>快</em>得令人惊讶。以去除某些功能（如<hl></hl>Thumb<hl></hl>指令集和调试功能）为代价，DEC<hl></hl>成功地跨越了兆赫门槛，触及高达<hl></hl>233 MHz<hl></hl>的运行速度。作为一名普通用户，如果你准备购买新的<hl></hl>ARM<hl></hl>电脑（例如<hl></hl><em>RiscPC</em>），摆在你面前的是两个选择：一台搭载<hl></hl>40 MHz ARM710<hl></hl>老旧处理器的电脑，或者一台运行速度快约<hl></hl>582%<hl></hl>的<hl></hl>StrongARM<hl></hl>电脑。 StrongARM<hl></hl>的影响如此巨大，以至于<hl></hl>ARM Holdings<hl></hl>吸收了一些<hl></hl>StrongARM<hl></hl>的特性，用于生产他们的下一代<hl></hl>CPU，也就是<hl></hl>ARM9<hl></hl>及之后的系列。其余就是些老黄历了。</p><p>但这里就是我的问题所在：明明见到了<hl></hl>ARM<hl></hl>世日新月异的发展，为什么任天堂最终选择了一个速度极慢的<hl></hl>ARM9<hl></hl>处理器，再加上一个速度更慢的<hl></hl>ARM7，而不是选择一个更快的<hl></hl>ARM9（甚至是一个<hl></hl>StrongARM）呢？抛砖引玉，其他公司（例如苹果）就在新出的<hl></hl>Newton PDA<hl></hl>系列中采用了<hl></hl>StrongARM<hl></hl>处理器。</p><p>我不是要批评任天堂的决策，但我认为新兴技术数量多到很难让人视而不见。我猜可能是为了保全电池寿命（译注：从充满电到用到没电的使用时长）并且控制生产成本（通过使用与<hl></hl>GBA<hl></hl>相同的<hl></hl>CPU）。</p><h3 id="图形">图形</h3><p>这一部分有些不太寻常，因为这款游戏机不仅有多个屏幕需要绘制，而且把传统的图块（tile）引擎与现代渲染器结合在了一起。</p><p>首先说说硬件：NDS<hl></hl>包含两个<hl></hl>LCD<hl></hl>屏幕，每个屏幕的都有<hl></hl><strong>256x192<hl></hl>个像素</strong>，比<hl></hl>GBA<hl></hl>多约<hl></hl>20％个像素点。它们可以显示<hl></hl>262144<hl></hl>种颜色（18<hl></hl>位），刷新率约<hl></hl>60 Hz。</p><h4 id="架构">架构</h4><p>图形子系统可以绘制<hl></hl>2D<hl></hl>和<hl></hl>3D<hl></hl>对象。前者由二维几何图形组成，其中填充了<hl></hl>8x8<hl></hl>像素的位图（称为<hl></hl>“图块”），而后者则使用顶点绘制三维对象（多边形）。</p><p>深入了解操作这些屏幕的内部芯片，我们可以观察到这个掌机具有独特的<hl></hl>2D<hl></hl>和<hl></hl>3D<hl></hl>几何图形硬件。2D<hl></hl>数据由我们熟悉的引擎 PPU（现在只称之为<hl></hl><strong>2D<hl></hl>引擎</strong>）操作，而<hl></hl>3D<hl></hl>数据由一个全新的子系统处理。值得一提的是，虽然这并不是<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-64">第一款</a>推出<hl></hl>3D<hl></hl>图形功能的游戏机，但它仍然是第一款使用自研图形渲染器来呈现<hl></hl>3D<hl></hl>图形的游戏机。</p><figure><img loading="lazy" src="/notes/images/copetti-nds/overall.7404a7aeb6d004cc64ad5edcd1a42c759dc105f3b3ffcb26e33a2d552c0fd0e8.png" alt="不同图形单元的布局。"><figcaption aria-hidden="true">不同图形单元的布局。</figcaption></figure><p>现在，这两个引擎必须连接到两个屏幕其中之一。对于只有<hl></hl>2D<hl></hl>图形的游戏来说，这不是问题，因为每个屏幕都有一个<hl></hl>2D<hl></hl>引擎。然而，那些想展示前沿特性的游戏却只有一个<hl></hl>3D<hl></hl>引擎可用。因此，每次只能在一个屏幕上使用<hl></hl>3D<hl></hl>功能。但是<hl></hl>2D<hl></hl>和<hl></hl>3D<hl></hl>对象如何混合显示？别急，我先分别解释清楚这两个引擎，之后再讨论这个问题。</p><h4 id="使用2d图形构建帧">使用<hl></hl>2D<hl></hl>图形构建帧</h4><p>在我们检查各阶段之前，我建议先阅读有关<hl></hl>GBA PPU<hl></hl>的<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#graphics">这篇文章</a>，因为在这里我只会提到构建<hl></hl>“下一代”2D<hl></hl>游戏的变化。另外，由于有两个引擎，这里我们把第一个引擎称为<strong>主引擎（Main）</strong>，第二个则称为<strong>辅助引擎（Sub）</strong>。虽然这并不一定意味着哪个屏幕连接了哪个引擎，而且主引擎比辅助引擎包含更多的功能。</p><p>我将借用<em>新超级马里奥兄弟（New Super Mario Bros）</em>的资源（assets）来帮助解释。</p><h5 id="图块tiles">图块（Tiles）</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/tiles.5230eed389fc325b50fd5a4f6a7074898328515856d0d9cf140323832b771d57.png" alt="从VRAM中提取的图块。出于演示目的，使用了默认调色板。"><figcaption aria-hidden="true">从<hl></hl>VRAM<hl></hl>中提取的图块。出于演示目的，使用了默认调色板。</figcaption></figure><p>到目前为止，我们都知道基本的图块系统是如何工作的，但是<hl></hl>NDS<hl></hl>的图块处理有什么特别之处呢？其实，总共有<hl></hl><strong>656 KB VRAM</strong><hl></hl>可用，这一块被分割成不同的<hl></hl>bank：四个<hl></hl>128 KB bank、一个<hl></hl>64 KB bank、一个<hl></hl>32 KB bank<hl></hl>和三个<hl></hl>16 KB bank。开发者可以随便往<hl></hl>bank<hl></hl>里填充数据并将引擎指向所需数据的位置。两个引擎都可以从这些<hl></hl>bank<hl></hl>读数据，但是它们不能同时访问同一个<hl></hl>bank。</p><p>尽管如此，数据排布方式还是有一些限制。例如，ARM7<hl></hl>只能访问两个<hl></hl>128 KB<hl></hl>的<hl></hl>bank，这两个<hl></hl>bank<hl></hl>不能存储<hl></hl>sprite；最后<hl></hl>16 KB bank<hl></hl>只能被<hl></hl>“辅助引擎”<hl></hl>访问；等等等等……你懂得。</p><p>最后一句，3D<hl></hl>引擎我们稍后再讨论，它可以访问其中某些<hl></hl>bank<hl></hl>以获取纹理（texture）。</p><h5 id="背景类型">背景类型</h5><p>从<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/super-nintendo#graphics">Super Nintendo</a><hl></hl>时代开始，PPU<hl></hl>一直致力于为构建背景图层提供更多的灵活性。 14<hl></hl>年后，有这样一款芯片，可以获取图块并应用许多<strong>仿射变换</strong>。甚至，最终可以从<hl></hl>frame buffer<hl></hl>构建图层。</p><p>在我们讨论<hl></hl>2D<hl></hl>引擎显示背景的不同模式之前，让我们先了解一下引擎可以生成哪些类型的背景：</p><ul><li><strong>字符类型（Character type）组</strong>：这些背景类型遵循传统的图块系统，通过填充图块来渲染帧。<ul><li><strong>静态（Static）</strong>或者说<hl></hl>“文本”（text）背景：普通背景，最大支持<hl></hl>512x512<hl></hl>像素，256<hl></hl>色和<hl></hl>16<hl></hl>个调色板。包括了所有典型的<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/super-nintendo#tab-1-2-background">特效（effects）</a>（H/V<hl></hl>翻转、H/V<hl></hl>滚动、马赛克、alpha<hl></hl>混合），外加一个额外的 “褪色”<hl></hl>效果。最多可使用<hl></hl>1024<hl></hl>个图块。</li><li><strong>仿射（Affine）</strong>背景：一个带有<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/super-nintendo#unique-features">仿射变换（affine transformations）</a>的背景，不支持水平<hl></hl>/<hl></hl>垂直翻转，并且只能获取<hl></hl>256<hl></hl>个图块<hl></hl>(最大值的四分之一)。图层大小为<hl></hl>1024x1024<hl></hl>像素。</li><li><strong>仿射扩展（Affine Extended）</strong>背景：与<hl></hl>affine<hl></hl>背景相同，但是可使用<hl></hl>1024<hl></hl>个图块，并且支持水平<hl></hl>/<hl></hl>垂直翻转。</li></ul></li><li><strong>位图（Bitmap）类型组</strong>：引擎不再处理图块，直接把<hl></hl>VRAM<hl></hl>用作<hl></hl>frame buffer。所有的位图类型都继承了<hl></hl>character affine<hl></hl>背景的所有效果。<ul><li><strong>256<hl></hl>色扩展（256 colours Extended）</strong>：使用<hl></hl>512x512 px<hl></hl>的帧缓冲区。</li><li><strong>直接颜色扩展（Direct colour Extended）</strong>：与<hl></hl>256<hl></hl>色扩展类似，但<hl></hl>frame buffer<hl></hl>支持的颜色提高到<hl></hl>32768<hl></hl>种（15<hl></hl>位）。</li><li><strong>大屏幕（Large screen）</strong>：利用所有四块<hl></hl>128 KB<hl></hl>大的<hl></hl>VRAM<hl></hl>块来渲染一个<hl></hl>1024x512 px<hl></hl>大的<hl></hl>frame-buffer。</li></ul></li></ul><p>开发者不能任意选择背景类型。但是游戏机提供了一系列<strong>背景模式</strong>，为各类型设置了不同的组合。</p><h5 id="背景模式">背景模式</h5><div class="column-3"><figure><img loading="lazy" src="/notes/images/copetti-nds/bg1.9c782df96fc338c8dfb1a1f95c425edeaaf768ef59688480a6aad58ea99c26ef.png" class="text-justify" alt="背景图层 0 (BG0)。这个特定的图层将在某些扫描线上水平位移以模拟云的移动。"><figcaption aria-hidden="true">背景图层 0 (BG0)。这个特定的图层将在某些扫描线上水平位移以模拟云的移动。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/bg2.4130751330c73853da1a8979fdd4e57812b004d54267be3e37d31efae464634c.png" title="Layer 2" alt="背景图层 2 (BG2)。"><figcaption aria-hidden="true">背景图层 2 (BG2)。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/bg3.cf5b5f3aceb7e5d307a23c9529ab8652c4c633bbacb5b0001b3d57316a0da81f.png" title="Layer 3" alt="背景图层 3 (BG3)。"><figcaption aria-hidden="true">背景图层 3 (BG3)。</figcaption></figure></div><p>背景类型实战演示。主引擎和辅助引擎都提供了六种操作模式，所有模式都能生成四个背景图层，但每个图层的能力有所不同：</p><ul><li><strong>模式<hl></hl>0</strong>：4<hl></hl>个<hl></hl>static<hl></hl>图层。</li><li><strong>模式<hl></hl>1</strong>：3<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+1<hl></hl>个<hl></hl>affine<hl></hl>图层。</li><li><strong>模式<hl></hl>2</strong>：2<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+2<hl></hl>个<hl></hl>affine<hl></hl>图层。</li><li><strong>模式<hl></hl>3</strong>：3<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+1<hl></hl>个<hl></hl>extended affine<hl></hl>图层。</li><li><strong>模式<hl></hl>4</strong>：2<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+1<hl></hl>个<hl></hl>affine<hl></hl>图层<hl></hl>+1<hl></hl>个<hl></hl>extendine affine<hl></hl>图层。</li><li><strong>模式<hl></hl>5</strong>：2<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+2<hl></hl>个<hl></hl>extended affine<hl></hl>图层。<ul><li>这是最常用的模式，因为极其灵活。</li></ul></li><li><strong>模式<hl></hl>6</strong>：3D<hl></hl>引擎渲染的<hl></hl>1<hl></hl>个<hl></hl>static<hl></hl>图层<hl></hl>+ 1<hl></hl>个<hl></hl>large screen。<ul><li>由于<hl></hl>VRAM bank<hl></hl>的空间只够一个<hl></hl>frame buffer，因此只有主引擎能使用该模式。</li></ul></li></ul><h5 id="sprites">Sprites</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/sprites.774e46b73df7624ca335fa85206c5d1e92109d4ed1af89eba9dc36c124f99cfd.png" alt="渲染的Sprite图层."><figcaption aria-hidden="true">渲染的<hl></hl>Sprite<hl></hl>图层.</figcaption></figure><p>Sprites<hl></hl>或者说<hl></hl>“objects”<hl></hl>继承了<hl></hl>GBA PPU<hl></hl>的功能，但新增两个重要功能。</p><p>首先，OAM（存储<hl></hl>sprite<hl></hl>条目（sprites entries）的区域）的大小现在有<hl></hl><strong>2 KB</strong>，使每屏每帧可以显示多达<hl></hl>128<hl></hl>个<hl></hl>sprite。因此，两个引擎都分配有<hl></hl>1 KB。</p><p>其次，OAM<hl></hl>现在可以引用<hl></hl><strong>VRAM</strong><hl></hl>中的位图，而不仅仅使用图块和调色板。这是一种与<hl></hl>tile<hl></hl>系统不同的方法。实际上，同一帧中可以同时存在这两种<hl></hl>sprite“模式”，因为此选项是在每个单独的<hl></hl>sprite<hl></hl>上设置的。</p><h5 id="结果">结果</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/halfcomplete.35e87954aaa91b151ba44afff3f8b8c2de2bad4a3d557fa4b3889a614bad7fec.png" alt="合并所有图层……是不是少了什么？"><figcaption aria-hidden="true">合并所有图层……是不是少了什么？</figcaption></figure><p>由于每个图层都是即时渲染的，最后阶段需要合并所有内容并将其发送到所选屏幕。以前基于<hl></hl>PPU<hl></hl>渲染游戏机基本如此，但这是否意味着<hl></hl>NDS<hl></hl>也到这里结束了？</p><p>还没呢！主引擎仍然必须从另一个引擎——最强大的引擎——获取图层。</p><h4 id="d-加速">3D 加速</h4><p>如果你之前玩过<hl></hl>NDS，那么你就知道这款游戏机可以显示<em>一定</em>数量的<hl></hl>3D<hl></hl>图形。不同于<hl></hl>GBA<hl></hl>游戏，这些<hl></hl>3D<hl></hl>图形并非由<hl></hl>CPU<hl></hl>处理。不过，CPU-NTR<hl></hl>包括<strong>两个组件</strong>来构建<hl></hl><strong>3D<hl></hl>引擎</strong>。有趣的是，任天堂采用的设计让我想起了<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-64#graphics">SGI<hl></hl>的<hl></hl>RCP</a>。</p><p>回顾<hl></hl>“背景模式”<hl></hl>部分，你会注意到每个模式都至少有一个<hl></hl>static<hl></hl>背景，这是因为你可以用<hl></hl>3D<hl></hl>引擎生成的图形来填充该图层。唯一需要注意的是只有主引擎可以这样做，这也是模式<hl></hl>6<hl></hl>仅适用于主引擎的原因之一。</p><h5 id="几何引擎">几何引擎</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/geometry.2ad99e396bdb4f7579c5a1360fd7e4027cb41ab97795c79a1c230a06eb022555.png" alt="几何引擎的架构。"><figcaption aria-hidden="true">几何引擎的架构。</figcaption></figure><p>如果读过第四代或第五代游戏机的文章，你可能会想知道……<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/sega-saturn#graphics">SIMD<hl></hl>处理器</a>哪去了？这是个好问题，因为<hl></hl>ARM9<hl></hl>并不擅长矢量运算，而且我不认为专用除法器很够用。这就是为什么任天堂嵌入了一个叫做<strong>几何引擎</strong>的组件，它负责<strong>顶点变换</strong>、<strong>投影</strong>、<strong>光线</strong>、<strong>裁剪</strong>、<strong>剔除</strong>和<strong>多边形排序</strong>，后者对于正确使用透明特性是必不可少的。</p><p>这个引擎有一些严格的限制，特别是它能够处理的多边形数量：有额外的<hl></hl>248 KB RAM<hl></hl>可用于存储处理过的几何体，数量可以达到<hl></hl>2048<hl></hl>个三角形或<hl></hl>1706<hl></hl>个四边形。使用多边形条带的话（而不是单个多边形）还可以存储更多。为了对这个数字有一些概念，我建议查看之前文章中的<hl></hl>“交互模型”<hl></hl>部分，你会发现这个限制令人担忧，但不要忘记掌机的屏幕分辨率也要小得多……所以算是抵消了一点。</p><p>无论如何，这个引擎是通过一个<hl></hl><strong>Command FIFO</strong><hl></hl>来控制的，其数据是由<hl></hl>CPU<hl></hl>或<hl></hl>DMA<hl></hl>填充。该<hl></hl>FIFO<hl></hl>可以存储<hl></hl>256<hl></hl>个条目，并且它还有一个叫做<hl></hl><strong>PIPE</strong><hl></hl>的缓冲区，用于存储额外的四个命令（总共<hl></hl>260<hl></hl>个命令）。</p><h5 id="渲染引擎">渲染引擎</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/rendering.5a62b69875c626d7fedd9d831a271720db214cd65f2ce7f6ff653efbd119e226.png" alt="渲染引擎的架构。"><figcaption aria-hidden="true">渲染引擎的架构。</figcaption></figure><p>渲染引擎负责将向量转换为像素（光栅化），着色（纹理映射）并应用光照和其他效果。它依靠<strong>透视校正</strong>和<hl></hl><strong>Gouraud 着色</strong>分别用来处理插值纹理和光照。此外，该单元提供一些现代特性，例如<hl></hl><strong>fog</strong>，<strong>alpha<hl></hl>混合</strong>，<strong>深度缓冲</strong>（<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-64#modern-visible-surface-determination">Z<hl></hl>缓冲</a>，或是一种被称为<hl></hl>W<hl></hl>缓冲的变体），<strong>模板测试</strong>和<strong>抗锯齿</strong>。虽然最后一项非常原始（将多边形的外部边缘设置透明而已），而且只能用于不透明像素。</p><p>渲染系统采用了新旧结合的方式：它没有直接渲染到<hl></hl>frame buffer，而是采用<strong>行缓存渲染（line buffer rendering）</strong>，在每一条扫描线上填充像素（类似于<hl></hl>2D<hl></hl>引擎），并将结果存储在一个较小的缓缓冲区中。这是因为<hl></hl>3D<hl></hl>引擎必须与<hl></hl>2D<hl></hl>绘图器同步工作。</p><p>没有传统的<hl></hl>frame buffer，光栅化器采用了<strong>扫描线渲染（scan-line rendering）</strong>，遍历每个扫描线以处理其中的多边形边缘。 Arisotura（MelonDS<hl></hl>模拟器的开发者）称，对于每个四边形，渲染器只能在每条扫描线上填充<strong>一个<hl></hl>span</strong><span class="citation" data-cites="graphics-arisotura">[<a href="#ref-graphics-arisotura" role="doc-biblioref">6</a>]</span>。这可能会有隐患，因为如果四边形是凹四边形或者有交叉的边，结果会变得一团糟。</p><p>关于效果，该单元还提供<hl></hl><strong>shadowing</strong><hl></hl>和一个被称为<hl></hl><strong>Toon Shading</strong><hl></hl>的独特功能（又称<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/gamecube#creativity">Cel Shading</a>）：该单元<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/xbox#importance-of-programmability">不可编程</a>，但也可以通过改变照明参数达到卡通效果。</p><h5 id="结果-1">结果</h5><figure><img loading="lazy" src="/notes/images/copetti-nds/complete.ad64c1f4bb4e348934057c8f4809801019adc8e0ad46312f00c17fd40c24b475.png" alt="这就对了嘛！"><figcaption aria-hidden="true">这就对了嘛！</figcaption></figure><p>渲染引擎将不会将结果写回<hl></hl>frame buffer<hl></hl>以供显示，而是写入一个名为<hl></hl><strong>Color Buffer</strong><hl></hl>的块中，该块可以存储多达<hl></hl>48<hl></hl>条扫描线。 2D<hl></hl>引擎会按照先进先出（FIFO）的方式获取每条扫描线，以填充<hl></hl>BG0<hl></hl>图层。</p><p>3D<hl></hl>渲染在<hl></hl>2D<hl></hl>渲染之前开始，使后者在必要时能够应用图形变换到新图层。主引擎还允许捕获生成的<hl></hl>2D<hl></hl>帧、3D<hl></hl>帧或组合帧，将其与<hl></hl>VRAM<hl></hl>中的另一个帧混合（blend），并将结果写回<hl></hl>VRAM，之后可以用于显示。</p><p>在控制方面，由于采用了基于双缓冲的机制，渲染引擎还允许在帧中间改变参数，该机制可以保留旧状态的副本，直到当前帧绘制完成。因此，不会出现图像撕裂的现象。</p><h4 id="知名游戏比较">知名游戏比较</h4><p>一些最初在<hl></hl>NDS<hl></hl>上发布的游戏试图模仿另一台游戏机（即<hl></hl>N64）上的游戏。玩家可能会看到两种版本之间存在重大差异，我想简要总结一下原因：</p><h5 id="第一个例子">第一个例子</h5><div class="column-2"><figure><img loading="lazy" src="/notes/images/copetti-nds/sm64.webp" alt="超级马力欧64（1996） 以320×240像素渲染。"><figcaption aria-hidden="true">超级马力欧<hl></hl>64（1996）<br>以<hl></hl>320×240<hl></hl>像素渲染。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/mario_nds.04fb4ba2c7f403a3b9f80621b69aa0a7a1598d69fa48595b0bc5a7edb9974474.png" alt="超级马力欧64 DS（2004） 以256x192像素渲染。"><figcaption aria-hidden="true">超级马力欧<hl></hl>64 DS（2004）<br>以<hl></hl>256x192<hl></hl>像素渲染。</figcaption></figure></div><h5 id="第二个例子">第二个例子</h5><div class="column-2"><figure><img loading="lazy" src="/notes/images/copetti-nds/kart_n64.61e7d61169033127a969fbcb9dd34e8c3f3fdc47ef63675884d8a067aa71bdf0.png" alt="马力欧卡丁车64（1996） 以320×240像素渲染。"><figcaption aria-hidden="true">马力欧卡丁车<hl></hl>64（1996）<br>以<hl></hl>320×240<hl></hl>像素渲染。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/kart_nds.c9910fb86a35fc4ceae49f36f1ead5435a69c3b600f065f08c1a6a8c8aa7e41f.png" alt="马力欧卡丁车DS（2005） 以256x192像素渲染。"><figcaption aria-hidden="true">马力欧卡丁车<hl></hl>DS（2005）<br>以<hl></hl>256x192<hl></hl>像素渲染。</figcaption></figure></div><p>所以，为了解释这里发生了什么，我将根据一些论坛用户的说法，整理出几条不同的解释：</p><ul><li><em>NDS<hl></hl>版的纹理看起来更加<strong>方块</strong></em> → 渲染引擎没有使用任何滤波器，因此纹理使用<hl></hl>“最近邻”<hl></hl>方法进行插值。</li><li><em>NDS<hl></hl>版的纹理看起来更加<strong>丰富</strong></em> → 渲染引擎没有<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-64#tab-3-2-texture-memory">4KB TMEM</a><hl></hl>的限制。相反，除了提供的压缩机制外，最多还有<hl></hl>512KB<hl></hl>的<hl></hl>VRAM<hl></hl>可用，因此可以加载更多数据。</li><li><em>NDS<hl></hl>模型的边缘出现了<strong>锯齿</strong></em> → 与<hl></hl>N64<hl></hl>相比，NDS<hl></hl>模型的分辨率较低。</li><li><em>NDS<hl></hl>的纹理当从远处看起来会出现<strong>失真</strong>的情况</em> → 光栅化器使用的是<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/playstation#missing-units">定点</a>坐标。低分辨率和<hl></hl>mip-mapping<hl></hl>的缺乏也加剧了走形程度。</li></ul><p>简要的概述这就是这些。如果想要了解更专业的情况，你可能需要深入研究两个引擎，甚至反汇编这两个游戏来研究所使用的功能以及他们的用法。</p><h4 id="交互模型">交互模型</h4><p>我更新了<hl></hl>wee model<hl></hl>查看器，添加了<hl></hl>“最近邻插值”<hl></hl>功能。这样你就可以使用你自己的<hl></hl>GPU<hl></hl>来查看<hl></hl>NDS<hl></hl>模型了。</p><p><em>请前往原网站体验交互式小部件。</em></p><div class="column-2"><figure><img loading="lazy" src="/notes/images/copetti-nds/mario_ds.328af9a5eff0002b12a6ce4f9d2392f0172ce370833ffed7d30b775b0a4a952e.png" alt="新马力欧兄弟（2004） 636个三角形。"><figcaption aria-hidden="true">新马力欧兄弟（2004）<br>636<hl></hl>个三角形。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/dalmatian_ds.0eb38a8b7b76bf681e31cde8d8cb11a87ca990ff13e22f48590ce8528571ae5e.png" alt="任天狗狗（2005） 750个三角形。"><figcaption aria-hidden="true">任天狗狗（2005）<br>750<hl></hl>个三角形。</figcaption></figure></div><p>尽管我们讨论了图形子系统的诸多限制，但很多游戏确实充分利用了它的功能。</p><h3 id="音频">音频</h3><p>大多数音频改进都集中在增强<hl></hl>GBA<hl></hl>所<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#audio">提供</a>的那些<hl></hl>PCM<hl></hl>声道上。我们之前看到过，GBA<hl></hl>游戏最终将软件序列优先于<hl></hl>PSG，结果非常令人印象深刻。</p><figure><video src="https://www.copetti.org/videos/consoles/nintendods/window.f6d130a028e73e0e5b7ad90c08ddd4cef6c2774c27d93d280055277d075ca586.mp4" class="text-justify" controls><a target="_blank" rel="noopener" href="https://www.copetti.org/videos/consoles/nintendods/window.f6d130a028e73e0e5b7ad90c08ddd4cef6c2774c27d93d280055277d075ca586.mp4">最后之窗真夜中的约束（2010）。展示混合立体声输出。</a></video><figcaption aria-hidden="true">最后之窗真夜中的约束（2010）。展示混合立体声输出。</figcaption></figure><p>因此，新的音频系统总共有<hl></hl><strong>16<hl></hl>个<hl></hl>PCM<hl></hl>声道（channels）</strong>，可以将混音任务转移到硬件上。 PCM<hl></hl>采样可以是<hl></hl><strong>8<hl></hl>比特</strong>（<em>GBA<hl></hl>风格</em>）、<strong>16<hl></hl>比特</strong>（最高解析度）或<hl></hl>ACPCM（压缩形式）。无论如何，混音器都会产生一个立体声信号，可以通过扬声器（现在是立体声）或耳机播放。它还可以将生成的立体声数据写入<hl></hl>WRAM，让子处理器（ARM7）能够应用一些效果，例如混响。</p><p>尽管以上内容已经介绍了不少，但这是否意味着<hl></hl>NDS<hl></hl>终于可以播放编码音乐（例如<hl></hl>MP3）？这是可行的（实际上，许多自制程序都实现了某种形式的音频解码），但音频解码需要大量的带宽和处理能力<hl></hl><span class="citation" data-cites="cpu-homebrew">[<a href="#ref-cpu-homebrew" role="doc-biblioref">7</a>]</span>。所以，音频序列仍然是可行最高的选项。</p><h4 id="有关psg的一个也许两个古怪之处">有关<hl></hl>PSG<hl></hl>的一个（也许两个）古怪之处</h4><p>NDS<hl></hl>可以运行<hl></hl>GBA<hl></hl>游戏，因此它应该具有类似于前代<hl></hl>PSG<hl></hl>的功能（无论是通过硬件还是软件实现）。正好，最后<hl></hl>6<hl></hl>个声道包含一个<hl></hl>“PSG<hl></hl>模式”，允许其中任何一个合成脉冲或自定义波形，并且其中只有两个声道可以产生噪声。但是<hl></hl>GBA<hl></hl>游戏没有使用其中任何一个功能！</p><p>你看，混音器的输出频率是<hl></hl>32 kHz，解析度为<hl></hl>10<hl></hl>比特（远低于输入样本的质量）。此外，混音器<strong>没有执行任何形式的插值</strong>来平滑精度的损失。这些限制对样本来说并不理想，因为它会引入噪声。尽管这种现象的实际感知取决于你的听觉能力（我不会注意到有<hl></hl>“噪声”，除非我把音量调高并将其与<hl></hl>16<hl></hl>比特版本放到一起比较），但这仍然是从使用<hl></hl>8<hl></hl>比特解析度软件混合采样以来的一大进步。与之相比，PSG<hl></hl>的声音的混叠效应更为棘手，因为降采样信号可能会引入错误的谐波，使原始的<hl></hl>PSG<hl></hl>音调失真。然而，像《新超级马里奥兄弟》这样的游戏，脉冲波伴奏就用得很欢，所以我不认为<hl></hl>PSG<hl></hl>完全没有用处。</p><p>回到主题，GBA<hl></hl>游戏是如何处理的呢？答案是没有处理。任天堂为<hl></hl>GBA<hl></hl>模式适配了一个单独的声音系统（在同一外壳里），其中包括符合<hl></hl>GBA<hl></hl>的规格的私有的声道和混音器。这样，GBA<hl></hl>游戏就不会被新混音器限制所影响。不幸的是，NDS<hl></hl>游戏无法使用这个子系统，因为它与<hl></hl>NDS<hl></hl>的系统相隔离。换句话说，它不能输出到<hl></hl>NDS<hl></hl>的混音器。</p><h4 id="交互式比较">交互式比较</h4><p>我构建了这个交互式小部件，让你可以自己来回比较，从而理解新的音频系统如何影响新一代游戏的配乐。每个小部件都可以播放相同的曲子，但允许你在旧版和新版之间切换（建议戴上耳机以更好地体验差异）。试一试！</p><p><em>请前往原网站体验交互式小部件。</em></p><p>不得不说，我得稍微增加<hl></hl>GBA<hl></hl>原声音乐的增益才能把音量调整正常，这往往会影响信噪比（来回切换时请记住这一点）。无论如何，我希望您能感受到声音子系统是如何演变的。</p><h4 id="提升难度">提升难度</h4><p>现在请让我展示一些棘手的情况。移植游戏的原平台有一些独特的音频功能，在<hl></hl>NDS<hl></hl>上重现这些功能可不简单。现在请你来当评委：</p><p><em>请前往原网站体验交互式小部件。</em></p><p>正如你从第一个示例中听到的（特别是在最后<hl></hl>10<hl></hl>秒钟内），要与<hl></hl>SNES<hl></hl>的<hl></hl>S-SMP<hl></hl>所提供的功能相竞争有些困难。</p><p>必须承认，第二个例子是我故意放上去的。我的意思是，<em>究竟</em>发生了什么？就好像这个新的编排最初就是为雅达利游戏机而设计的一样。如果你问我，我认为<hl></hl>NDS<hl></hl>可以处理某种形式的<hl></hl>FM<hl></hl>到<hl></hl>PCM<hl></hl>重新采样，所以这个新的<em>极简主义</em>编排可能只是一种创造性的方法。</p><h3 id="io">I/O</h3><p>长话短说，I/O<hl></hl>严格交由<hl></hl>ARM7<hl></hl>处理。事实上，除传递数据之外，你不会看到<hl></hl>ARM7<hl></hl>处理器有多少操作……这真是太可惜了。</p><h4 id="卡带与内存的访问">卡带与内存的访问</h4><p>有一个连接三个<hl></hl>endpoint<hl></hl>的外部内存接口：<strong>Slot-1</strong>（用于放置<hl></hl>NDS<hl></hl>卡带）、<strong>Slot-2</strong>（用于放置<hl></hl>GBA<hl></hl>卡带或配件）以及<hl></hl><strong>4 MB PSRAM</strong>（主内存）。两个<hl></hl>CPU<hl></hl>均可访问该接口。接口中包含可以修改的寄存器，以便设定<hl></hl>CPU<hl></hl>优先级，在同一时间有两个总线请求时优先哪颗<hl></hl>CPU。</p><figure><img loading="lazy" src="/notes/images/copetti-nds/memoryaccess.7180c7884abeff7aff44e9f8f78455f0a39a74c41a5e2a0345591e0910169b6c.png" alt="外部存储器模型，标记了数据总线的宽度。"><figcaption aria-hidden="true">外部存储器模型，标记了数据总线的宽度。</figcaption></figure><p>现在要说重要的一点：NDS<hl></hl>卡带<strong>没有内存映射</strong>。为了让任一<hl></hl>CPU<hl></hl>读取游戏数据，首先必须把内容复制到<hl></hl>RAM<hl></hl>中。这是通过向卡带发送包含<hl></hl>8<hl></hl>位命令和<hl></hl>32<hl></hl>位地址引用的数据块来实现的。之后，可以通过<hl></hl>32<hl></hl>位寄存器或<hl></hl>DMA<hl></hl>手动获取数据。数据总线宽度只有<hl></hl>8<hl></hl>位，但速度最高可达<hl></hl><strong>5.96 MB<hl></hl>每秒</strong>（如任天堂所述）。</p><p>用于保存备份的芯片（如<hl></hl>EEPROM、FLASH 和 FRAM）可以通过<hl></hl>SPI<hl></hl>总线（串行）访问。该总线使用自己的一套命令集，并连接到一个<hl></hl>24<hl></hl>位地址总线。</p><p>使用本来的引脚排布的话，Slot-2<hl></hl>卡槽是内存映射的。但在<hl></hl>DS<hl></hl>模式下，为了适配提供扩展功能的硬件（额外的<hl></hl>RAM、震动等），地址会被移位。就像<hl></hl>GBA<hl></hl>一样，ROM<hl></hl>总线为<hl></hl>16<hl></hl>位宽，RAM<hl></hl>总线则有<hl></hl>8<hl></hl>位宽。</p><h4 id="外部设备">外部设备</h4><p>ARM7<hl></hl>也连接到另一个<hl></hl>SPI<hl></hl>节点，即<strong>触摸屏控制器</strong>的接口。该接口可以操作底部屏幕（电阻式，需要使用触控笔）和闪存存储器（<em>固件</em>就存储在这里，稍后再做详细介绍）。</p><div class="column-2"><figure><img loading="lazy" src="/notes/images/copetti-nds/puzzle.3252b8c89bc6153ba99d708c55a47cacb859404747c1e73d7b7d520efc0644e7.png" class="text-justify" alt="愿望之屋 天使的记忆（2007）前面提到的总机难题。为了营救小姑娘，玩家必须同时用两根手指滑动屏幕才能开灯。"><figcaption aria-hidden="true">愿望之屋 天使的记忆（2007）前面提到的总机难题。为了营救小姑娘，玩家必须同时用两根手指滑动屏幕才能开灯。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/puzzle_fail.24dad4afb133e61cfd8bebe22e9e23d7661bd9a4bdb51f8bc6e06f442173ad0b.png" alt="但如果你做错了……"><figcaption aria-hidden="true">但如果你做错了……</figcaption></figure></div><p>这个触摸屏的一个有趣的特点，除了检测<hl></hl>X/Y<hl></hl>位置的功能，它还可以返回<strong>对角线位置</strong>（用于计算<hl></hl>“压力值”，表示施加压力的区域）。不幸的是，这个特性从未在官方<hl></hl>SDK<hl></hl>中公开。据我所知，没有游戏最终使用了这个未记录的特性，除了自制游戏。</p><p>许多人指出，《愿望之屋 天使的记忆》依靠这个特性来解决其中一个谜题，需要用户同时使用两个手指。然而，情况并非如此。在使用<hl></hl>no$gba debugger<hl></hl>实验之后，可以发现这个谜题并没有用到压力数据，而是检查<hl></hl>X/Y<hl></hl>值是否交替剧烈变化。游戏将这种效果解释为用户用两个手指按压屏幕的结果。</p><p>最后，同一堆东西里还有<strong>实时时钟</strong> (real-time clock, RTC)。</p><h4 id="无线网络">无线网络</h4><p>最后但同样重要的是，掌机包含一个运行在<hl></hl>2.4 GHz<hl></hl>频段的<strong>无线控制器</strong>，提供了一些创新功能：</p><ul><li><strong>Internet Play</strong>：使任何游戏都能使用标准<hl></hl>Wi-Fi<hl></hl>连接连接到<hl></hl>LAN<hl></hl>网络。</li><li><strong>Multi-card Play</strong>：使用专有协议，最多可以联机<hl></hl>16<hl></hl>台掌机。</li><li><strong>Single-card Play</strong>：游戏可以将上传程序到另一个没装游戏卡的<hl></hl>DS。</li></ul><h3 id="操作系统">操作系统</h3><p>我觉得基本可以认为，这一世代的每款游戏机都带有了某种交互界面。 NDS<hl></hl>继承了以轻量级<hl></hl>API<hl></hl>为基础的操作系统模型，以简化<hl></hl>I/O<hl></hl>访问；但同时也提供了一个精简的用户界面，以供调整设置或者运行<hl></hl>“应用程序”。</p><p>话虽如此，它的操作系统分散在多个芯片中。让我们从启动时读取的芯片开始。</p><h4 id="入口点entry-point">入口点（Entry point）</h4><p>在某一时刻，ARM7<hl></hl>和<hl></hl>ARM9<hl></hl>将需要初始化硬件。 NTR-CPU<hl></hl>包括两个不同的小型<hl></hl>ROM<hl></hl>芯片来做这件事：</p><ul><li>一个连接到<hl></hl>ARM9<hl></hl>总线的<hl></hl><strong>4 KB BIOS</strong>。</li><li>一个连接到<hl></hl>ARM7<hl></hl>总线的<hl></hl><strong>16 KB BIOS</strong>。</li></ul><p>当掌机启动时，每个<hl></hl>CPU<hl></hl>从各自的<hl></hl>ROM<hl></hl>启动引导。这是因为它们的<strong>复位向量（reset vector）</strong>指向每个芯片（作为参考，ARM9<hl></hl>的向量位于<hl></hl><code>0xFFFF0000</code>，而<hl></hl>ARM7<hl></hl>的向量位于<hl></hl><code>0x00000000</code>）<span class="citation" data-cites="operating_system-boot">[<a href="#ref-operating_system-boot" role="doc-biblioref">8</a>]</span>。</p><p>继续推进，两个<hl></hl>BIOS<hl></hl>都存储两组例程：引导代码和中断调用。考虑到<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#anti-piracy--homebrew">前代掌机</a>的历史，后者我们并不陌生，然而前者的复杂度却增加了：除了硬件初始化之外，ARM7<hl></hl>的代码还将对<hl></hl>DS<hl></hl>卡带（如果插入了的话）进行一些检查来确保安全性。</p><p>运行引导代码后，两个<hl></hl>CPU<hl></hl>将同步，以便它们可以开始充当<hl></hl>“单个机器”：事实证明，ARM9<hl></hl>的加载完成要比<hl></hl>ARM7<hl></hl>快得多。于是<hl></hl>ARM9<hl></hl>向<hl></hl>ARM7<hl></hl>发送一个<hl></hl>4<hl></hl>比特值，在半无限循环中阻塞等待<hl></hl>ARM7<hl></hl>的响应。一旦<hl></hl>ARM7<hl></hl>响应，两者同时<hl></hl>“越过终点线”，也就是说，它们现在同步了。</p><h4 id="机会之窗">机会之窗</h4><p>如果您现在拥有或者曾经拥有<hl></hl>NDS，您可能会注意到<strong>只能</strong>在游戏机开机前插入卡带才能玩游戏。这是因为<hl></hl>ARM7<hl></hl>的<hl></hl>BIOS<hl></hl>在启动时对卡带进行了一些检查（更多详情参见最后一节），如果所有测试都通过，ARM7<hl></hl>的游戏可执行程序将被复制到<hl></hl>WRAM，ARM9<hl></hl>的程序则被复制到主内存。</p><p>如果出于某些原因未能复制可执行文件（卡带无效或在启动时未找到可执行文件），则无法启动游戏。用户将不得不重置游戏机才能玩游戏。</p><h4 id="交互界面">交互界面</h4><p>无论是否插卡，系统都将加载交互界面完成引导。这只是一个驻留在外部<hl></hl><strong>256 KB<hl></hl>闪存</strong>存储器上的程序<hl></hl><span class="citation" data-cites="operating_system-firmware">[<a href="#ref-operating_system-firmware" role="doc-biblioref">9</a>]</span>。</p><div class="column-3"><figure><img loading="lazy" src="/notes/images/copetti-nds/home.ae99f466c3aff87fd7ed7bdfb071b1103028e5a1f03862b1ce7dbd4a4a9800f8.png" alt="主界面。"><figcaption aria-hidden="true">主界面。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/welcome.aafdd9167176109031fd1b318ce63d658c99b6ee2604d3b802e24da12137ab6c.png" class="text-justify" alt="每次NDS开机时都会看到此界面。在有效插入一张卡时“Nintendo” logo会显示出来。"><figcaption aria-hidden="true">每次<hl></hl>NDS<hl></hl>开机时都会看到此界面。在有效插入一张卡时<hl></hl>“Nintendo” logo<hl></hl>会显示出来。</figcaption></figure><figure><img loading="lazy" src="/notes/images/copetti-nds/settings.6923c874c8a139a9464c2ee39e3188d9a06fd1c18c93b2e3251eb7fde1a58d95.png" alt="设置界面。"><figcaption aria-hidden="true">设置界面。</figcaption></figure></div><p>存储界面的芯片还存储着固件、一些用户设置（语言、昵称、生日、闹钟和欢迎消息）以及一些系统设置（触摸屏校准、首次启动标志、固件版本和<hl></hl>Wi-Fi<hl></hl>设置）。</p><p>这个界面与其他同期的游戏机界面基本上差不多。用户依靠它来启动游戏、更改设置、下载游戏（使用<hl></hl>“Download Play”<hl></hl>功能）或者玩玩<hl></hl><strong>Pictochat</strong>：一个开放的聊天室软件，可以与附近的<hl></hl>NDS<hl></hl>交流。</p><p>值得强调的是，只读数据和可写数据都驻留在同一个可重写的芯片中，因此理论上固件可以被覆盖！幸运的是（或者出于显而易见的原因），任天堂在主板上的一个点（称为<hl></hl><code>SL1</code>）上放置了跳线来保护芯片的上四分之一（64 KB）不被写入，拆卸电池仓后可以看到这个点。然而，仍然可以覆盖闪存的其余部分，虽然结果也是灾难性的<hl></hl><span class="citation" data-cites="operating_system-bricker">[<a href="#ref-operating_system-bricker" role="doc-biblioref">10</a>]</span>！</p><h4 id="可更新性">可更新性</h4><p>任天堂为了修复一些安全漏洞，曾多次更新这个固件（确切地说是<hl></hl>5<hl></hl>次）。用户无法自行安装这些更新（回想一下<hl></hl><code>SL1</code><hl></hl>的保护）。但是，任天堂在下一批生产的产品中嵌入了更新后的固件。</p><h3 id="游戏">游戏</h3><p>这里能说的可就多了，首要原因是这个游戏机确实启发开发者和艺术家们想出了非常创新的设计。让我们来看看……</p><h4 id="存储介质">存储介质</h4><p>这个游戏机可以从三个来源运行游戏，其中只有两个可以充分地利用硬件：</p><figure><img loading="lazy" src="/notes/images/copetti-nds/hu7ba926da3dded5df907d42933d810e7d_106900_f054132f02f34736f26a1b2345c1e469.webp" alt="一款零售游戏的例子。"><figcaption aria-hidden="true">一款零售游戏的例子。</figcaption></figure><ul><li><strong>NDS<hl></hl>或者说<hl></hl>“Slot-1”<hl></hl>卡带</strong>：用于加载原生<hl></hl>NDS<hl></hl>游戏的主要介质，这是用于发行<hl></hl>NDS<hl></hl>游戏的唯一介质。</li><li><strong>GBA<hl></hl>或者说<hl></hl>“Slot-2”<hl></hl>卡带</strong>：该插槽使得掌机能够原生游玩<hl></hl>GBA<hl></hl>游戏。Slot-1<hl></hl>游戏也可以访问此插槽，因此可以插入<strong>扩展卡带</strong>以增强<hl></hl>NDS<hl></hl>游戏。这提供了诸多功能如更多<hl></hl>RAM、更丰富的输入控制或反馈设备（例如<em>振动包</em>）。</li><li><strong>Download Play<hl></hl>或<hl></hl>“无线多重启动（Wireless MultiBoot）”</strong>：原<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy-advance#accessories">多重启动（MultiBoot）</a>功能的升级版，使另一个带有<hl></hl>NDS<hl></hl>游戏的掌机能够使用无线通信上传程序。下载的内容存储在<hl></hl>WRAM<hl></hl>中，传输完成后启动。由于<hl></hl>WRAM<hl></hl>是易失性存储器，数据在关机时将丢失。<ul><li>获得授权的零售商可以使用此功能部署<strong>下载站</strong>，邀请用户在到店参观时下载演示版游戏。</li></ul></li></ul><h4 id="程序的结构">程序的结构</h4><p>你已经见过<hl></hl>BIOS<hl></hl>需要分别为<hl></hl>ARM9<hl></hl>和<hl></hl>ARM7<hl></hl>编写不同的代码，在游戏中基本也是同样的情况。NDS<hl></hl>卡的结构如下：</p><ul><li><strong>Header（4 KB）</strong>：包含元数据（各个可执行文件的位置、序列号等）。</li><li><strong>Secure Area（16 KB）</strong>：出于复制保护的目的而设置。我们将在本文的最后一部分详细介绍相关内容。</li><li><strong>Main content（大小可变）</strong>：卡带的其余部分，仅包含可执行文件和游戏数据（图形、声音等）。使用任天堂的<hl></hl>SDK<hl></hl>制作的零售游戏使用内置的文件系统将数据层次化地组织为文件和目录。</li></ul><h4 id="开发生态">开发生态</h4><p>对于有意为该掌机开发游戏的游戏工作室，任天堂分发了硬件套件和<hl></hl>SDK，其中包括许多实用工具。</p><h5 id="硬件">硬件</h5><p>被称为<hl></hl><strong>IS-NITRO-EMULATOR</strong><hl></hl>的开发套件由一个中等大小的蓝色盒子组成，包含<hl></hl>DS<hl></hl>的大部分内部硬件和<hl></hl>I/O<hl></hl>接口<hl></hl><span class="citation" data-cites="games-emulator">[<a href="#ref-games-emulator" role="doc-biblioref">11</a>]</span>。套件通过一根粗电缆连接到一个充当<hl></hl>“控制器”<hl></hl>和显示器的伪<hl></hl>NDS<hl></hl>外壳。根据需求，开发工具包还可以增加可选功能，例如音频<hl></hl>/<hl></hl>视频输出、Wi-Fi（默认情况下使用以太网模拟）和调试功能。我原以为后者已经包含在内了，但我意识到这些设备也可以被测试团队使用。</p><p>该套件可以读取<hl></hl>DS<hl></hl>卡带，但是需要使用较大的卡片和可更换的备份芯片。这些卡片使用被称为<hl></hl><strong>IS-NITRO-WRITER</strong><hl></hl>的另一个单元刷写。</p><h5 id="软件">软件</h5><p>软件套件包括用于与开发工具包交互的实用程序、C/C++<hl></hl>工具链和硬件<hl></hl>API。需要提到的一点是，文档明确禁止绕过提供的<hl></hl>API<hl></hl>直接访问硬件：尽管<strong>游戏将在裸机上运行</strong>，但如果它执行<hl></hl>“违禁”<hl></hl>操作，任天堂将不会批准其分发。违禁操作包括直接控制<hl></hl>ARM7，超出显示分辨率或者关闭<hl></hl>LCD<hl></hl>屏幕。</p><p>这些措施情有可原，例如为了保证质量水平。尽管在我看来，把<hl></hl>ARM7<hl></hl>拘束在<hl></hl>I/O<hl></hl>任务里纯属浪费……</p><h4 id="交互的自由">交互的自由</h4><figure><img loading="lazy" src="/notes/images/copetti-nds/kawashima.da43bc42cbbe80c60b055a3fddc3406cd81fd40e948e8a06d2c6bf7f0ffaa668.png" alt="脑锻炼（2005） 新品类的游戏吸引了青少年之外的受众。"><figcaption aria-hidden="true">脑锻炼（2005）<br>新品类的游戏吸引了青少年之外的受众。</figcaption></figure><p>随着新型交互形式的出现，工作室就有机会优先考虑游戏体验而不是图形显示。</p><p>在电子消费品中，一款把触摸屏、麦克风、Wi-Fi<hl></hl>和一个实时时钟封装到一起的掌机第一次出现。一些游戏甚至提出了新的互动形式，比如指示用户侧握掌机。</p><h4 id="网络服务">网络服务</h4><p>在<a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/xbox#network-service">以前的竞争对手</a>获得成功之后，任天堂也加入了在线多人游戏俱乐部，并部署了他们的集中式基础设施。使用<hl></hl>“Internet Play”<hl></hl>的游戏可以连接到任天堂的服务器（称为<hl></hl><strong>Nintendo Wi-Fi Connection</strong>）在线游玩游戏。</p><h3 id="反盗版和自制游戏">反盗版和自制游戏</h3><p>即使<hl></hl>DS<hl></hl>卡没有受到<em>光盘诅咒</em>的影响，任天堂还是实施了一些保护措施以保持对游戏发行的控制。</p><h4 id="安全机制">安全机制</h4><p>让我们看看各个领域的安全机制：</p><h5 id="加密系统">加密系统</h5><p>NDS<hl></hl>主要使用对称加密系统对内存接口和<hl></hl>Slot-1<hl></hl>卡之间的通信进行加密。在讨论如何加密之前，我们需要先聊一聊所使用的算法以及如何生成用于加密的密钥。</p><p>卡片的<hl></hl>“Header”<hl></hl>区域包含一个名为<hl></hl><strong>Gamecode</strong><hl></hl>的值（游戏的唯一标识符），内存接口抓取这个块来生成<hl></hl><strong>KEY1</strong><hl></hl>并使用它来加密进一步发送到卡片的命令。 KEY1<hl></hl>加密基于<hl></hl><strong>Blowfish<hl></hl>算法</strong>。</p><p>之后，KEY1<hl></hl>与内部时钟和卡带<hl></hl>Header<hl></hl>的一些其他值混合，生成一个新的密钥，称为<hl></hl><strong>KEY2</strong>。 KEY2<hl></hl>与<hl></hl>KEY1<hl></hl>的根本区别在于，前者使用随机值所以无法被预测。 KEY2<hl></hl>加密使用多个异或与移位操作来混淆数据。</p><h5 id="ds卡的校验">DS<hl></hl>卡的校验</h5><p>正如我们上面看到的那样，BIOS<hl></hl>包括一些例程，在启动时校验<hl></hl>NDS<hl></hl>游戏卡。工作原理如下：</p><ol type="1"><li>掌机检索卡带的芯片<hl></hl>ID，将其保存在<hl></hl>RAM<hl></hl>上，然后启用<hl></hl>KEY1<hl></hl>加密。</li><li>“安全区”<hl></hl>的前<hl></hl>2KB<hl></hl>也被复制到<hl></hl>RAM<hl></hl>上。该块的前<hl></hl>8B<hl></hl>存储了一个名为<hl></hl><strong>Secure Area ID</strong><hl></hl>的字符串，后面的数据包含校验和（CRC16<hl></hl>类型）与一些其他元数据。</li><li>虽然<hl></hl>“Secure Area ID”<hl></hl>已经用<hl></hl>KEY1<hl></hl>加密过了，但是还要用<hl></hl>KEY2<hl></hl>再次加密，之后用到时再解密。如果解密后的值与字符串<hl></hl><code>encryObj</code><hl></hl>相匹配，说明卡片<strong>通过了校验第一次关</strong>。此后，该字符串被销毁，防止算法泄露。如果验证失败，Secure Area<hl></hl>的<hl></hl>2KB<hl></hl>就会被无意义数据填满，阻止读取卡片的其他部分。</li><li>第二个测试流程为再次检索芯片<hl></hl>ID，然后用<hl></hl>KEY2<hl></hl>随机加密若干次（使用内部时钟做种）。如果芯片<hl></hl>ID<hl></hl>的值与存储的第一个芯片<hl></hl>ID<hl></hl>相匹配，则<strong>第二次测试通过</strong>。</li><li>最后，Secure area<hl></hl>的其余部分以随机顺序被取走并在<hl></hl>RAM<hl></hl>中重新构建。之后就该执行固件了。</li></ol><p>如果一切顺利，固件将在<hl></hl>RAM<hl></hl>中找到该卡所需的可执行文件，从而成功启动游戏。否则，游戏选择框将显示为灰色。</p><h5 id="download-play-保护">Download Play 保护</h5><p>通过<hl></hl>Download Play<hl></hl>收到的程序必须由任天堂使用<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/wii#tab-7-2-chain-of-trust">RSA<hl></hl>签名</a>（只有任天堂知道私钥）进行签名。</p><p>该检查由固件执行。</p><h4 id="击败">击败</h4><p>如果你是自制软件使用者，那么你可能会遇到可以运行该软件的选项。事实是，在发现目前的破解方法之前，黑客们很难绕过任天堂复杂的反盗版系统。</p><h5 id="existing-slot-2">Existing Slot-2</h5><p>由于<hl></hl>GBA<hl></hl>子系统仍然在没有实施任何保护的情况下执行卡带（除了<hl></hl><a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/game-boy#anti-piracy">trademark tricks</a>），现有的<hl></hl>GBA<hl></hl>闪存卡仍然与<hl></hl>NDS<hl></hl>兼容。这使得运行<hl></hl>GBA<hl></hl>自制软件成为可能，如果你不介意错过<hl></hl>DS<hl></hl>游戏独有的所有新功能，那就可以正常运行。</p><p>一如既往，烧录卡带也能运行盗版<hl></hl>ROM，但由于任天堂不能改变<hl></hl>GBA<hl></hl>的保护系统（因为它有可能使现有游戏无法使用），所以只得处理这个问题。</p><h5 id="enhanced-slot-2">Enhanced Slot-2</h5><p>秘密地深入研究<hl></hl>DS BIOS<hl></hl>和固件后，最终发现可以把<hl></hl>NDS<hl></hl>卡的执行重定向到<hl></hl>GBA<hl></hl>插槽。尽管<hl></hl>NDS<hl></hl>卡还没有被破解，但这种方法允许暂时绕过<hl></hl>Slot-1<hl></hl>卡的安全系统，并在<hl></hl><strong>DS<hl></hl>模式下执行<hl></hl>Slot-2<hl></hl>程序</strong>。</p><p>因此，市面上出现了一种新一代的<hl></hl>Slot-2<hl></hl>烧录卡。它们内嵌了<hl></hl>ARM9<hl></hl>代码，一旦从<hl></hl>Slot-1<hl></hl>启动就会执行。引导本身是使用发现的上述方法之一（被称为<hl></hl>“passthrough<hl></hl>方法”）实现的：</p><ul><li>使用<hl></hl><strong>PassMe</strong><hl></hl>卡：该方法需要一个真正的<hl></hl>Slot-1<hl></hl>卡。 PassMe<hl></hl>是一种处于<hl></hl>Slot-1<hl></hl>和真正的游戏卡之间的适配器。它基本上篡改了从卡片发送到游戏机的<hl></hl>header，以欺骗控制台执行<hl></hl>Slot-2<hl></hl>代码，并在此过程中加载<hl></hl>Slot-2<hl></hl>卡带。</li><li>使用<hl></hl><strong>WifiMe</strong>：该方法需要一台带有兼容<hl></hl>Wi-Fi<hl></hl>卡的<hl></hl>PC。修改驱动程序，然后可以广播自定义程序让<hl></hl>NDS<hl></hl>通过<hl></hl>Download Play<hl></hl>下载。<span class="citation" data-cites="anti_piracy-wifime">[<a href="#ref-anti_piracy-wifime" role="doc-biblioref">12</a>]</span> 一旦启动，它就会重定向执行到<hl></hl>Slot-2。这种方法利用了固件不会检查二进制文件特定区域的<hl></hl>RSA<hl></hl>签名这件事。</li><li>使用 <strong>FlashMe</strong>：一劳永逸的方案。通过连接先前的方法并桥接<hl></hl><code>SL1</code><hl></hl>终端，可以运行一个自制程序，该程序可以在闪存卡存在的情况下覆盖固件以从<hl></hl>Slot-2<hl></hl>引导。</li><li>这个破解还删除了从<hl></hl>Download Play<hl></hl>引导自制程序时的数字签名检查。</li></ul><p>如预期的那样，任天堂推出了包含新固件的新版<hl></hl>NDS，修补了这些漏洞。因此，黑客更多地侧重于寻找<hl></hl>BIOS<hl></hl>的漏洞（很难修补）。</p><h5 id="native-slot-1">Native Slot-1</h5><p>著名<hl></hl>NDS<hl></hl>模拟器<hl></hl>“NO$GBA”<hl></hl>的开发者<hl></hl>Martin Korth<hl></hl>随后成功提取了<hl></hl>BIOS<hl></hl>并逆向工程了<hl></hl>Slot-1<hl></hl>的安全机制。这样一来，就可以用更新的工具和文档揭示<hl></hl>NDS<hl></hl>真实的安全机制。正如你在本文中看到的那样，加密系统只要没有被破解就可以运行。这是对称加密系统的一个局限，非对称加密系统（例如<hl></hl>RSA，永远不会存储私钥）就不会。</p><p>无论如何，这导致市场涌入了大量的<strong>即插即用<hl></hl>Slot-1<hl></hl>烧录卡</strong>。这些卡可以在任何类型的掌机上<strong>原生</strong>运行<hl></hl>NDS<hl></hl>程序。随着<hl></hl>“NoPass”<hl></hl>卡的推出，passthrough<hl></hl>方法也得到了改进。这些烧录卡可以在没有真正的游戏的情况下加载<hl></hl>Slot-2<hl></hl>烧录卡。</p><p>由于加密系统无法更改除法对现有的所有零售游戏造成影响，任天堂最终输掉了这场战斗。现在，他们唯一剩下的选择就是走法律途径，就像为前代游戏机所做的一样。</p><p>在我看来，与以前的游戏机的自制方法相比，烧录卡确实简单得引人注目。在之前的文章中我曾经描述过，用户必须深入迷宫般繁琐的步骤才能运行自制或盗版游戏。</p><p>就<hl></hl>NDS<hl></hl>而言，烧录卡就像零售游戏一样销售。我觉得游戏工作室看到用户轻松就能诉诸盗版，情况确实堪忧。</p><p>另一件事是，市场上出现的闪存卡品牌的数量也令人惊讶（不计所有仿冒品）。从技术角度看，烧录卡只不过是<hl></hl>SD<hl></hl>卡适配器<hl></hl><span class="citation" data-cites="anti_piracy-acekard">[<a href="#ref-anti_piracy-acekard" role="doc-biblioref">13</a>]</span>。每张卡与其他卡的唯一区别是引导代码和<hl></hl>SD<hl></hl>读卡器。一些制造商还投入更多的精力设计更好的文件浏览器（称为内核<hl></hl>/<hl></hl>固件），还加入了一些额外的硬件。</p><h3 id="结语">结语</h3><p>到这里就结束了！</p><figure><img loading="lazy" src="/notes/images/copetti-nds/hue1311088105060a4cc22235121bd9e0a_97866_89da5e0cce788f69b582c1e430c81c20.webp" alt="我目前用于本研究的NDS。 实际上我的第一台很久以前就被我卖掉了……好奇它现在在哪。"><figcaption aria-hidden="true">我<em>目前</em>用于本研究的<hl></hl>NDS。<br>实际上我的第一台很久以前就被我卖掉了……好奇它现在在哪。</figcaption></figure><p>好嘞！我觉得我已经谈到了我想说的内容的<hl></hl>99%……</p><p>我希望我对某些部分的批评听起来不会太苛刻。不要误会我的意思，我仍然认为这款游戏机是优秀的工程！只不过有一些缺陷让我怀疑它是否真的是一种对性价比的妥协，还是设计缺陷的一部分。说实话，这并不妨碍当时<hl></hl>11<hl></hl>岁的我想要一台<hl></hl>NDS。所以我觉得这对公司来说已经算是<hl></hl>“任务完成”<hl></hl>了！</p><p>还要感谢我的朋友们和<hl></hl>MelonDS<hl></hl>社区的大家抽出时间检查我的草稿并提出<em>大量</em>更正。 NDS<hl></hl>给我一个机会让我写下之前我就感兴趣的许多话题。虽然担心我一口吃了个胖子，但希望你能够喜欢这篇文章。</p><p>下篇文章见！ Rodrigo</p><h3 class="unnumbered" data-toc-unnumbered="true" id="参考文献">参考文献</h3><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list"><div id="ref-copetti-nintendods" class="csl-entry" role="listitem"><div class="csl-left-margin">[1]</div><div class="csl-right-inline">R. Copetti, <span>“Nintendo DS architecture - a practical analysis.”</span> 2020. Available: <a target="_blank" rel="noopener" href="https://www.copetti.org/writings/consoles/nintendo-ds/">https://www.copetti.org/writings/consoles/nintendo-ds/</a></div></div><div id="ref-cpu-arm9reference" class="csl-entry" role="listitem"><div class="csl-left-margin">[2]</div><div class="csl-right-inline">A. Holdings, <span>“ARM946E-s technical reference manual.”</span> 2022. Available: <a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0201/d/introduction/about-the-arm946e-s-processor">https://developer.arm.com/documentation/ddi0201/d/introduction/about-the-arm946e-s-processor</a></div></div><div id="ref-cpu-double" class="csl-entry" role="listitem"><div class="csl-left-margin">[3]</div><div class="csl-right-inline">C. Double, <span>“ARM9-ARM7 FIFO.”</span> 2005. Available: <a target="_blank" rel="noopener" href="http://double.nz/nintendo_ds/nds_develop7.html">http://double.nz/nintendo_ds/nds_develop7.html</a></div></div><div id="ref-cpu-korth" class="csl-entry" role="listitem"><div class="csl-left-margin">[4]</div><div class="csl-right-inline">M. Korth, <span>“Gameboy advance / nintendo DS.”</span> 2014. Available: <a target="_blank" rel="noopener" href="https://problemkaputt.de/gbatek.htm">https://problemkaputt.de/gbatek.htm</a></div></div><div id="ref-cpu-jaggar" class="csl-entry" role="listitem"><div class="csl-left-margin">[5]</div><div class="csl-right-inline">D. Jaggar, <span>“ARM microprocessor rise and fall.”</span> 2020. Available: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=%5c_6sh097Dk5k">https://www.youtube.com/watch?v=%5c_6sh097Dk5k</a></div></div><div id="ref-graphics-arisotura" class="csl-entry" role="listitem"><div class="csl-left-margin">[6]</div><div class="csl-right-inline">Arisotura, <span>“The DS GPU and its fun quirks.”</span> 2018. Available: <a target="_blank" rel="noopener" href="http://melonds.kuribo64.net/comments.php?id=56">http://melonds.kuribo64.net/comments.php?id=56</a></div></div><div id="ref-cpu-homebrew" class="csl-entry" role="listitem"><div class="csl-left-margin">[7]</div><div class="csl-right-inline"><span class="nocase">osdl.sourceforge.net</span>, <span>“A guide to homebrew development for the nintendo DS.”</span> 2008. Available: <a target="_blank" rel="noopener" href="http://osdl.sourceforge.net/main/documentation/misc/nintendo-DS/homebrew-guide/HomebrewForDS.html">http://osdl.sourceforge.net/main/documentation/misc/nintendo-DS/homebrew-guide/HomebrewForDS.html</a></div></div><div id="ref-operating_system-boot" class="csl-entry" role="listitem"><div class="csl-left-margin">[8]</div><div class="csl-right-inline"><span class="nocase">psiloveomega</span>, <span>“Booting the nintendo DS – a technical summary.”</span> 2010. Available: <a target="_blank" rel="noopener" href="https://corgids.wordpress.com/2017/07/28/booting-the-nintendo-ds-a-technical-summary/">https://corgids.wordpress.com/2017/07/28/booting-the-nintendo-ds-a-technical-summary/</a></div></div><div id="ref-operating_system-firmware" class="csl-entry" role="listitem"><div class="csl-left-margin">[9]</div><div class="csl-right-inline">Pocketheaven.com, <span>“DS firmware.”</span> 2007. Available: <a target="_blank" rel="noopener" href="https://web.archive.org/web/20071127014755/http://wiki.pocketheaven.com/DS_Firmware">https://web.archive.org/web/20071127014755/http://wiki.pocketheaven.com/DS_Firmware</a></div></div><div id="ref-operating_system-bricker" class="csl-entry" role="listitem"><div class="csl-left-margin">[10]</div><div class="csl-right-inline">Pocketheaven.com, <span>“DS bricker.”</span> 2007. Available: <a target="_blank" rel="noopener" href="https://web.archive.org/web/20100807234939/http://www.pocketheaven.com/ph/wiki/DS_Bricker#r0mloader.zip">https://web.archive.org/web/20100807234939/http://www.pocketheaven.com/ph/wiki/DS_Bricker#r0mloader.zip</a></div></div><div id="ref-games-emulator" class="csl-entry" role="listitem"><div class="csl-left-margin">[11]</div><div class="csl-right-inline"><span class="nocase">nsmbhd.net</span>, <span>“IS NITRO EMULATOR listing.”</span> 2018. Available: <a target="_blank" rel="noopener" href="https://nsmbhd.net/thread/4438-nintendo-ds-dev-hardware-is-nitro-emulator-and-co/#61422">https://nsmbhd.net/thread/4438-nintendo-ds-dev-hardware-is-nitro-emulator-and-co/#61422</a></div></div><div id="ref-anti_piracy-wifime" class="csl-entry" role="listitem"><div class="csl-left-margin">[12]</div><div class="csl-right-inline"><span class="nocase">ndsbackup.com</span>, <span>“NDS WiFiMe.”</span> 2005. Available: <a target="_blank" rel="noopener" href="https://web.archive.org/web/20180827093014/https://www.ndsbackup.com/wifime.htm">https://web.archive.org/web/20180827093014/https://www.ndsbackup.com/wifime.htm</a></div></div><div id="ref-anti_piracy-acekard" class="csl-entry" role="listitem"><div class="csl-left-margin">[13]</div><div class="csl-right-inline">Acekard, <span>“Acekard RPG 4.06 source code.”</span> 2007. Available: <a target="_blank" rel="noopener" href="https://gbatemp.net/threads/acekard-rpg-os-menu-4-06-and-sourcs-code-out.69656/">https://gbatemp.net/threads/acekard-rpg-os-menu-4-06-and-sourcs-code-out.69656/</a></div></div></div></div></article><aside class="post-widget"><h4>目录<hl></hl></h4><nav class="post-toc-wrap" id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AF%91%E8%80%85%E5%BA%8F"><span class="post-toc-number">1.</span> <span class="post-toc-text">译者序<hl></hl></span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="post-toc-number">2.</span> <span class="post-toc-text">快速入门<hl></hl></span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#cpu"><span class="post-toc-number">3.</span> <span class="post-toc-text">CPU</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">设计<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#arm7tdmi"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">ARM7TDMI</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#arm946e-s"><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">ARM946E-S</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%92%E8%BF%9E"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">互连<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%BB%E5%AD%98%E5%82%A8%E5%99%A8"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">主存储器<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%90%91%E5%90%8E%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">向后兼容性<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%A7%98%E5%AF%86%E5%92%8C%E9%99%90%E5%88%B6"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">秘密和限制<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%80%A7%E8%83%BD%E9%98%89%E5%89%B2"><span class="post-toc-number">3.5.1.</span> <span class="post-toc-text">性能阉割<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%85%B3%E4%BA%8E%E7%A1%AC%E4%BB%B6%E9%80%89%E6%8B%A9%E7%9A%84%E9%97%AE%E9%A2%98"><span class="post-toc-number">3.5.2.</span> <span class="post-toc-text">关于硬件选择的问题<hl></hl></span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9B%BE%E5%BD%A2"><span class="post-toc-number">4.</span> <span class="post-toc-text">图形<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">架构<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A82d%E5%9B%BE%E5%BD%A2%E6%9E%84%E5%BB%BA%E5%B8%A7"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">使用<hl></hl>2D<hl></hl>图形构建帧<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%9B%BE%E5%9D%97tiles"><span class="post-toc-number">4.2.1.</span> <span class="post-toc-text">图块（Tiles）</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%83%8C%E6%99%AF%E7%B1%BB%E5%9E%8B"><span class="post-toc-number">4.2.2.</span> <span class="post-toc-text">背景类型<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%83%8C%E6%99%AF%E6%A8%A1%E5%BC%8F"><span class="post-toc-number">4.2.3.</span> <span class="post-toc-text">背景模式<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#sprites"><span class="post-toc-number">4.2.4.</span> <span class="post-toc-text">Sprites</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="post-toc-number">4.2.5.</span> <span class="post-toc-text">结果<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#d-%E5%8A%A0%E9%80%9F"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">3D 加速<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%87%A0%E4%BD%95%E5%BC%95%E6%93%8E"><span class="post-toc-number">4.3.1.</span> <span class="post-toc-text">几何引擎<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E"><span class="post-toc-number">4.3.2.</span> <span class="post-toc-text">渲染引擎<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%9C-1"><span class="post-toc-number">4.3.3.</span> <span class="post-toc-text">结果<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%9F%A5%E5%90%8D%E6%B8%B8%E6%88%8F%E6%AF%94%E8%BE%83"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">知名游戏比较<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="post-toc-number">4.4.1.</span> <span class="post-toc-text">第一个例子<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="post-toc-number">4.4.2.</span> <span class="post-toc-text">第二个例子<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%9E%8B"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">交互模型<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9F%B3%E9%A2%91"><span class="post-toc-number">5.</span> <span class="post-toc-text">音频<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%9C%89%E5%85%B3psg%E7%9A%84%E4%B8%80%E4%B8%AA%E4%B9%9F%E8%AE%B8%E4%B8%A4%E4%B8%AA%E5%8F%A4%E6%80%AA%E4%B9%8B%E5%A4%84"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">有关<hl></hl>PSG<hl></hl>的一个（也许两个）古怪之处<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%AF%94%E8%BE%83"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">交互式比较<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8F%90%E5%8D%87%E9%9A%BE%E5%BA%A6"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">提升难度<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#io"><span class="post-toc-number">6.</span> <span class="post-toc-text">I/O</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8D%A1%E5%B8%A6%E4%B8%8E%E5%86%85%E5%AD%98%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">卡带与内存的访问<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%A4%96%E9%83%A8%E8%AE%BE%E5%A4%87"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">外部设备<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%97%A0%E7%BA%BF%E7%BD%91%E7%BB%9C"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">无线网络<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="post-toc-number">7.</span> <span class="post-toc-text">操作系统<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9entry-point"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">入口点（Entry point）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%9C%BA%E4%BC%9A%E4%B9%8B%E7%AA%97"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">机会之窗<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%A4%E4%BA%92%E7%95%8C%E9%9D%A2"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">交互界面<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8F%AF%E6%9B%B4%E6%96%B0%E6%80%A7"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">可更新性<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B8%B8%E6%88%8F"><span class="post-toc-number">8.</span> <span class="post-toc-text">游戏<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8"><span class="post-toc-number">8.1.</span> <span class="post-toc-text">存储介质<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84"><span class="post-toc-number">8.2.</span> <span class="post-toc-text">程序的结构<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%BC%80%E5%8F%91%E7%94%9F%E6%80%81"><span class="post-toc-number">8.3.</span> <span class="post-toc-text">开发生态<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%A1%AC%E4%BB%B6"><span class="post-toc-number">8.3.1.</span> <span class="post-toc-text">硬件<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%BD%AF%E4%BB%B6"><span class="post-toc-number">8.3.2.</span> <span class="post-toc-text">软件<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%A4%E4%BA%92%E7%9A%84%E8%87%AA%E7%94%B1"><span class="post-toc-number">8.4.</span> <span class="post-toc-text">交互的自由<hl></hl></span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1"><span class="post-toc-number">8.5.</span> <span class="post-toc-text">网络服务<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8F%8D%E7%9B%97%E7%89%88%E5%92%8C%E8%87%AA%E5%88%B6%E6%B8%B8%E6%88%8F"><span class="post-toc-number">9.</span> <span class="post-toc-text">反盗版和自制游戏<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="post-toc-number">9.1.</span> <span class="post-toc-text">安全机制<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%8A%A0%E5%AF%86%E7%B3%BB%E7%BB%9F"><span class="post-toc-number">9.1.1.</span> <span class="post-toc-text">加密系统<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#ds%E5%8D%A1%E7%9A%84%E6%A0%A1%E9%AA%8C"><span class="post-toc-number">9.1.2.</span> <span class="post-toc-text">DS<hl></hl>卡的校验<hl></hl></span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#download-play-%E4%BF%9D%E6%8A%A4"><span class="post-toc-number">9.1.3.</span> <span class="post-toc-text">Download Play 保护<hl></hl></span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%87%BB%E8%B4%A5"><span class="post-toc-number">9.2.</span> <span class="post-toc-text">击败<hl></hl></span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#existing-slot-2"><span class="post-toc-number">9.2.1.</span> <span class="post-toc-text">Existing Slot-2</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#enhanced-slot-2"><span class="post-toc-number">9.2.2.</span> <span class="post-toc-text">Enhanced Slot-2</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#native-slot-1"><span class="post-toc-number">9.2.3.</span> <span class="post-toc-text">Native Slot-1</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="post-toc-number">10.</span> <span class="post-toc-text">结语</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="post-toc-text">参考文献<hl></hl></span></a></li></ol></nav></aside></div><footer class="footer-nav"><div class="footer"><div class="back-top" id="back-top" title="Back to top"><i class="icon icon-chevron-bar-up"></i></div><div class="footer-content"><div class="footer-links"><div class="footer-links-column"><p><a title="Google Scholar" target="_blank" rel="noopener" href="https://scholar.google.com/">Google Scholar</a></p><p><a title="Google patents" target="_blank" rel="noopener" href="https://patents.google.com/">Google patents</a></p><p><a title="Bing Academic" target="_blank" rel="noopener" href="https://bing.com/academic/">Bing Academic</a></p></div><div class="footer-links-column"><p><a title="Web of Science" target="_blank" rel="noopener" href="https://www.webofscience.com/">Web of Science</a></p><p><a title="Science Direct" target="_blank" rel="noopener" href="https://www.sciencedirect.com/">Science Direct</a></p><p><a title="中国知网" target="_blank" rel="noopener" href="https://www.cnki.net/"><hl></hl>中国知网<hl></hl></a></p></div><div class="footer-links-column"><p><a title="arXiv" target="_blank" rel="noopener" href="https://arxiv.org/">arXiv</a></p><p><a title="JSTOR" target="_blank" rel="noopener" href="https://www.jstor.org/">JSTOR</a></p><p><a title="PubMed Central" target="_blank" rel="noopener" href="https://www.ncbi.nlm.nih.gov/pmc/">PubMed Central</a></p></div><div class="footer-links-column"><p><a title="MSI Eureka" target="_blank" rel="noopener" href="https://search.msi-eureka.com/search">MSI Eureka</a></p><p><a title="GitHub" target="_blank" rel="noopener" href="https://github.com/cerallin/">GitHub</a></p><p><a title="KUKE音乐" target="_blank" rel="noopener" href="https://www.kuke.com/">KUKE<hl></hl>音乐</a></p></div></div><div><span id="site_pv">?</span> PV <span id="site_uv">?</span> UV</div>Copyright © 2021<span class="time-divide">-</span>2026 Cerallin. Power by <a href="https://hexo.io/" target="_blank" rel="external nofollow">Hexo</a> and <a href="https://github.com/Cerallin/hexo-theme-yuzu" target="_blank" rel="external nofollow" title="v3.2.7">Theme Yuzu</a>.</div></div></footer><script>window.config={url_root:"/notes/",meta_path:"meta.json"}</script><script src="/notes/js/theme/back-to-top.js"></script><script src="/notes/js/theme/clipboard.js"></script><script src="/notes/js/theme/loading.js"></script><script src="/notes/js/theme/navbar.js"></script><script src="/notes/js/theme/search.js"></script><script src="/notes/js/theme/toc.js"></script><script src="/notes/js/theme/refs-sidebar.js"></script><script>window.onload=function(){for(var e in Theme)Theme[e].register()}</script></div><div class="search-modal" id="search-modal"><div class="card"><div class="card-head"><div class="search-box"><input class="search-input" id="search-input" placeholder="搜索"><div class="search-button" id="search-button"><div class="icon icon-search"></div></div></div><div class="close-button"><div class="icon icon-x"></div></div></div><div class="card-body"><div class="search-count">共<hl></hl><span id="search-count-num">0</span><hl></hl>条搜索结果。</div><div class="search-result" id="search-result"></div></div></div></div></body></html>